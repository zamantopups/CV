<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Ensures colors are printed correctly */
        @media print {
            body { 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important;
            }
        }
        /* Custom scrollbar for editor */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* CSS variables for themeing */
        :root {
            --accent-color: #1d4ed8; /* Blue-700 default */
            --accent-bg: #eff6ff; /* Blue-50 default */
        }
        
        .accent-color { color: var(--accent-color); }
        .bg-accent { background-color: var(--accent-color); }
        .border-accent { border-color: var(--accent-color); }
        .bg-accent-light { background-color: var(--accent-bg); }
        .ring-accent:focus { --tw-ring-color: var(--accent-color); }

        /* Styles for the active tab using variables */
        .tab-btn.active {
            color: var(--accent-color);
            border-bottom-width: 2px;
            border-color: var(--accent-color);
            background-color: var(--accent-bg);
        }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-800 min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-slate-900 text-white p-4 shadow-md print:hidden sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i data-lucide="pen-tool" class="w-6 h-6 accent-color" style="color: var(--accent-color);"></i>
                <h1 class="text-xl font-bold">CV Builder</h1>
            </div>
            <button onclick="window.print()" class="flex items-center gap-2 bg-accent hover:opacity-90 px-4 py-2 rounded-lg font-medium transition-colors" style="background-color: var(--accent-color);">
                <i data-lucide="download" class="w-4 h-4"></i>
                Save as PDF
            </button>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 md:p-8 flex flex-col lg:flex-row gap-8 w-full flex-grow">
        
        <!-- LEFT COLUMN: EDITOR -->
        <div class="w-full lg:w-1/3 print:hidden flex flex-col h-[calc(100vh-120px)] sticky top-24">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col h-full overflow-hidden">
                <!-- Tabs -->
                <div class="flex border-b border-slate-200 shrink-0 text-slate-500" id="tabs-container">
                    <button onclick="switchTab('personal')" class="tab-btn flex-1 py-3 text-sm font-medium capitalize transition-colors hover:bg-slate-50 active" data-tab="personal">Personal</button>
                    <button onclick="switchTab('experience')" class="tab-btn flex-1 py-3 text-sm font-medium capitalize transition-colors hover:bg-slate-50" data-tab="experience">Experience</button>
                    <button onclick="switchTab('education')" class="tab-btn flex-1 py-3 text-sm font-medium capitalize transition-colors hover:bg-slate-50" data-tab="education">Education</button>
                    <button onclick="switchTab('skills')" class="tab-btn flex-1 py-3 text-sm font-medium capitalize transition-colors hover:bg-slate-50" data-tab="skills">Skills</button>
                    <button onclick="switchTab('languages')" class="tab-btn flex-1 py-3 text-sm font-medium capitalize transition-colors hover:bg-slate-50" data-tab="languages">Languages</button>
                    <button onclick="switchTab('settings')" class="tab-btn flex-1 py-3 text-sm font-medium capitalize transition-colors hover:bg-slate-50" data-tab="settings">Settings</button>
                </div>

                <!-- Editor Form Area -->
                <div id="editor-content" class="p-6 overflow-y-auto custom-scrollbar">
                    <!-- Dynamic Content Injected Here -->
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: PREVIEW -->
        <div class="w-full lg:w-2/3 print:w-full print:absolute print:top-0 print:left-0 print:m-0 print:z-50">
            <div class="sticky top-24 print:static">
                <div id="cv-preview" class="bg-white shadow-2xl print:shadow-none w-full max-w-[210mm] mx-auto min-h-[297mm] p-[15mm] md:p-[20mm] text-slate-800 relative" style="aspect-ratio: 210/297;">
                    <!-- Dynamic Preview Content Injected Here -->
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- Initial Data State ---
        let state = {
            activeSection: 'personal',
            data: {
                themeColor: '#1d4ed8', // Blue-700 default
                photoUrl: '', // Base64 or local URL for photo
                personal: {
                    fullName: 'Alex Morgan',
                    role: 'Senior Product Designer',
                    email: 'alex.morgan@example.com',
                    phone: '+1 (555) 123-4567',
                    location: 'San Francisco, CA',
                    website: 'alexmorgan.design',
                    summary: 'Creative and detail-oriented Product Designer with over 6 years of experience in building user-centric digital products. Proven track record of improving user engagement and streamlining design processes. Adept at collaborating with cross-functional teams to deliver high-quality solutions.'
                },
                experience: [
                    {
                        id: 1,
                        title: 'Senior UX Designer',
                        company: 'TechFlow Solutions',
                        location: 'San Francisco, CA',
                        startDate: '2021-03',
                        endDate: 'Present',
                        description: '• Led the redesign of the core mobile application, resulting in a 25% increase in user retention.\n• Mentored a team of 3 junior designers and established a comprehensive design system.\n• Collaborated closely with engineering to ensure pixel-perfect implementation of designs.'
                    },
                    {
                        id: 2,
                        title: 'Product Designer',
                        company: 'Creative Pulse',
                        location: 'Austin, TX',
                        startDate: '2018-06',
                        endDate: '2021-02',
                        description: '• Designed and launched 5 major client projects from concept to delivery.\n• Conducted user research and usability testing to validate design decisions.\n• Created interactive prototypes to communicate interactions to stakeholders.'
                    }
                ],
                education: [
                    {
                        id: 1,
                        school: 'University of Texas at Austin',
                        degree: 'Bachelor of Fine Arts in Design',
                        location: 'Austin, TX',
                        startDate: '2014-09',
                        endDate: '2018-05'
                    }
                ],
                skills: [
                    'Figma', 'Adobe Creative Suite', 'Prototyping', 'HTML/CSS', 
                    'User Research', 'Agile Methodology', 'Design Systems', 'React Basic'
                ],
                languages: [
                    { id: 1, name: 'English', level: 'Native' },
                    { id: 2, name: 'Spanish', level: 'Intermediate' }
                ],
                // Projects section has been removed
            }
        };

        // --- Theme & Setup Functions ---
        function applyTheme() {
            const color = state.data.themeColor;
            document.documentElement.style.setProperty('--accent-color', color);
            // Calculate a lighter background for the accent color, used in tabs
            let r = parseInt(color.substring(1, 3), 16);
            let g = parseInt(color.substring(3, 5), 16);
            let b = parseInt(color.substring(5, 7), 16);
            // Mix with white (255, 255, 255) to get a light shade (e.g., 90% white, 10% color)
            r = Math.round(r * 0.1 + 255 * 0.9);
            g = Math.round(g * 0.1 + 255 * 0.9);
            b = Math.round(b * 0.1 + 255 * 0.9);
            const lightColor = '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
            document.documentElement.style.setProperty('--accent-bg', lightColor);
        }

        function renderApp() {
            applyTheme();
            switchTab(state.activeSection); // Call switchTab to render editor and preview
            lucide.createIcons();
        }

        function switchTab(tabName) {
            state.activeSection = tabName;
            
            // Update Tab Styles
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if(btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            renderEditor();
            renderPreview();
            lucide.createIcons();
        }

        // --- Render Editor Section ---
        function renderEditor() {
            const container = document.getElementById('editor-content');
            const { activeSection, data } = state;
            let html = '';

            if (activeSection === 'personal') {
                html = `
                    <div class="space-y-4 animate-in">
                        <h2 class="text-lg font-semibold flex items-center gap-2 text-slate-800">
                            <i data-lucide="user" class="w-5 h-5 accent-color"></i> Personal Details
                        </h2>
                        ${createInput('Full Name', 'fullName', data.personal.fullName)}
                        ${createInput('Job Title', 'role', data.personal.role)}
                        <div class="grid grid-cols-2 gap-4">
                            ${createInput('Email', 'email', data.personal.email)}
                            ${createInput('Phone', 'phone', data.personal.phone)}
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            ${createInput('Location', 'location', data.personal.location)}
                            ${createInput('Website', 'website', data.personal.website, 'portfolio.com')}
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">Professional Summary</label>
                            <textarea oninput="handlePersonalChange(this, 'summary')" rows="4" 
                                class="w-full rounded-lg border-slate-300 border p-2 text-sm focus:ring-2 ring-accent focus:border-transparent outline-none transition-all"
                            >${data.personal.summary}</textarea>
                        </div>
                    </div>
                `;
            } else if (activeSection === 'experience') {
                html = `
                    <div class="space-y-6 animate-in">
                        <div class="flex justify-between items-center">
                            <h2 class="text-lg font-semibold flex items-center gap-2 text-slate-800">
                                <i data-lucide="briefcase" class="w-5 h-5 accent-color"></i> Experience
                            </h2>
                            <button onclick="addItem('experience')" class="text-sm flex items-center gap-1 accent-color hover:opacity-80 font-medium">
                                <i data-lucide="plus" class="w-4 h-4"></i> Add Job
                            </button>
                        </div>
                        ${data.experience.map(job => `
                            <div class="p-4 bg-slate-50 rounded-lg border border-slate-200 relative group">
                                <button onclick="removeItem('experience', ${job.id})" class="absolute top-2 right-2 text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                                <div class="space-y-3">
                                    ${createArrayInput('experience', job.id, 'Job Title', 'title', job.title)}
                                    ${createArrayInput('experience', job.id, 'Company', 'company', job.company)}
                                    <div class="grid grid-cols-2 gap-2">
                                        ${createArrayInput('experience', job.id, 'Start Date', 'startDate', job.startDate, 'MM/YYYY')}
                                        ${createArrayInput('experience', job.id, 'End Date', 'endDate', job.endDate, 'Present')}
                                    </div>
                                    ${createArrayInput('experience', job.id, 'Location', 'location', job.location)}
                                    <div>
                                        <label class="block text-xs font-medium text-slate-500 mb-1">Description</label>
                                        <textarea oninput="handleArrayChange('experience', ${job.id}, 'description', this.value)" rows="3" 
                                            class="w-full rounded-lg border-slate-300 border p-2 text-sm focus:ring-2 ring-accent outline-none" placeholder="• Achieved X..."
                                        >${job.description}</textarea>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (activeSection === 'education') {
                html = `
                    <div class="space-y-6 animate-in">
                        <div class="flex justify-between items-center">
                            <h2 class="text-lg font-semibold flex items-center gap-2 text-slate-800">
                                <i data-lucide="graduation-cap" class="w-5 h-5 accent-color"></i> Education
                            </h2>
                            <button onclick="addItem('education')" class="text-sm flex items-center gap-1 accent-color hover:opacity-80 font-medium">
                                <i data-lucide="plus" class="w-4 h-4"></i> Add School
                            </button>
                        </div>
                        ${data.education.map(edu => `
                            <div class="p-4 bg-slate-50 rounded-lg border border-slate-200 relative group">
                                <button onclick="removeItem('education', ${edu.id})" class="absolute top-2 right-2 text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                                <div class="space-y-3">
                                    ${createArrayInput('education', edu.id, 'School / University', 'school', edu.school)}
                                    ${createArrayInput('education', edu.id, 'Degree', 'degree', edu.degree)}
                                    <div class="grid grid-cols-2 gap-2">
                                        ${createArrayInput('education', edu.id, 'Start Date', 'startDate', edu.startDate, 'YYYY')}
                                        ${createArrayInput('education', edu.id, 'End Date', 'endDate', edu.endDate, 'YYYY')}
                                    </div>
                                    ${createArrayInput('education', edu.id, 'Location', 'location', edu.location)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (activeSection === 'skills') {
                html = `
                    <div class="space-y-4 animate-in">
                        <h2 class="text-lg font-semibold flex items-center gap-2 text-slate-800">
                            <i data-lucide="pen-tool" class="w-5 h-5 accent-color"></i> Skills
                        </h2>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">Skills (Comma separated)</label>
                            <textarea oninput="handleSkillsChange(this)" rows="6" 
                                class="w-full rounded-lg border-slate-300 border p-3 text-sm focus:ring-2 ring-accent outline-none leading-relaxed"
                                placeholder="Design, React, Leadership..."
                            >${data.skills.join(', ')}</textarea>
                            <p class="text-xs text-slate-400 mt-2">Separate each skill with a comma.</p>
                        </div>
                        <div class="flex flex-wrap gap-2 mt-4">
                            ${data.skills.map(skill => skill ? `<span class="px-2 py-1 bg-accent-light accent-color text-xs rounded-md">${skill}</span>` : '').join('')}
                        </div>
                    </div>
                `;
            } else if (activeSection === 'languages') {
                html = `
                    <div class="space-y-6 animate-in">
                        <div class="flex justify-between items-center">
                            <h2 class="text-lg font-semibold flex items-center gap-2 text-slate-800">
                                <i data-lucide="globe" class="w-5 h-5 accent-color"></i> Languages
                            </h2>
                            <button onclick="addItem('languages')" class="text-sm flex items-center gap-1 accent-color hover:opacity-80 font-medium">
                                <i data-lucide="plus" class="w-4 h-4"></i> Add Language
                            </button>
                        </div>
                        ${data.languages.map(lang => `
                            <div class="p-4 bg-slate-50 rounded-lg border border-slate-200 relative group">
                                <button onclick="removeItem('languages', ${lang.id})" class="absolute top-2 right-2 text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                                <div class="space-y-3">
                                    ${createArrayInput('languages', lang.id, 'Language Name', 'name', lang.name)}
                                    ${createArrayInput('languages', lang.id, 'Proficiency Level', 'level', lang.level, 'e.g., Native, Fluent, Beginner')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (activeSection === 'settings') {
                html = `
                    <div class="space-y-6 animate-in">
                        <h2 class="text-lg font-semibold flex items-center gap-2 text-slate-800 mb-6">
                            <i data-lucide="settings" class="w-5 h-5 accent-color"></i> Settings & Theme
                        </h2>
                        
                        <div class="p-4 bg-slate-50 rounded-lg border border-slate-200 space-y-3">
                            <label class="block text-sm font-medium text-slate-700">Accent Color</label>
                            <input type="color" value="${data.themeColor}" oninput="handleThemeChange(this.value)"
                                class="w-full h-10 rounded-lg border-slate-300 border cursor-pointer"
                            />
                            <p class="text-xs text-slate-500">Choose a color to customize the look of your CV.</p>
                        </div>

                        <div class="p-4 bg-slate-50 rounded-lg border border-slate-200 space-y-3">
                            <label class="block text-sm font-medium text-slate-700 mb-2">Profile Photo</label>
                            <div class="flex items-center gap-4">
                                <img id="photo-preview-editor" src="${data.photoUrl || 'https://placehold.co/80x80/e2e8f0/94a3b8?text=Photo'}" 
                                    onerror="this.src='https://placehold.co/80x80/e2e8f0/94a3b8?text=Photo'"
                                    class="w-20 h-20 rounded-full object-cover border-2 border-slate-300" 
                                    alt="Profile Photo"
                                />
                                <input type="file" accept="image/*" onchange="handlePhotoUpload(this.files[0])"
                                    class="text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200 cursor-pointer"
                                />
                            </div>
                            ${data.photoUrl ? `<button onclick="removePhoto()" class="text-xs text-red-500 hover:text-red-700 mt-2 flex items-center gap-1"><i data-lucide="x" class="w-3 h-3"></i> Remove Photo</button>` : ''}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // --- Render Preview Section ---
        function renderPreview() {
            const p = state.data.personal;
            const exp = state.data.experience;
            const edu = state.data.education;
            const skills = state.data.skills;
            const languages = state.data.languages;

            const html = `
                <!-- Header -->
                <header class="border-b-2 border-slate-800 pb-6 mb-6 flex items-center ${state.data.photoUrl ? 'gap-6' : ''}">
                    ${state.data.photoUrl ? `
                        <img src="${state.data.photoUrl}" 
                            onerror="this.style.display='none'"
                            class="w-24 h-24 rounded-full object-cover shrink-0" 
                            alt="Profile Photo"
                        />
                    ` : ''}
                    <div>
                        <h1 class="text-4xl font-bold uppercase tracking-tight text-slate-900 mb-2">${p.fullName || 'Your Name'}</h1>
                        <p class="text-xl text-slate-600 font-medium mb-4">${p.role || 'Your Role'}</p>
                        
                        <div class="flex flex-wrap gap-y-2 gap-x-4 text-sm text-slate-600">
                            ${p.email ? `<div class="flex items-center gap-1"><i data-lucide="mail" class="w-3.5 h-3.5 accent-color"></i><span>${p.email}</span></div>` : ''}
                            ${p.phone ? `<div class="flex items-center gap-1"><i data-lucide="phone" class="w-3.5 h-3.5 accent-color"></i><span>${p.phone}</span></div>` : ''}
                            ${p.location ? `<div class="flex items-center gap-1"><i data-lucide="map-pin" class="w-3.5 h-3.5 accent-color"></i><span>${p.location}</span></div>` : ''}
                            ${p.website ? `<div class="flex items-center gap-1"><i data-lucide="globe" class="w-3.5 h-3.5 accent-color"></i><span>${p.website}</span></div>` : ''}
                        </div>
                    </div>
                </header>

                <div class="space-y-6">
                    <!-- Summary -->
                    ${p.summary ? `
                        <section>
                            <h3 class="text-sm font-bold uppercase tracking-wider text-slate-500 border-b border-slate-200 mb-3 pb-1">Professional Summary</h3>
                            <p class="text-sm leading-relaxed text-slate-700 whitespace-pre-line">${p.summary}</p>
                        </section>
                    ` : ''}

                    <!-- Experience -->
                    ${exp.length > 0 ? `
                        <section>
                            <h3 class="text-sm font-bold uppercase tracking-wider text-slate-500 border-b border-slate-200 mb-4 pb-1">Experience</h3>
                            <div class="space-y-5">
                                ${exp.map(job => `
                                    <div>
                                        <div class="flex justify-between items-baseline mb-1">
                                            <h4 class="font-bold text-slate-800">${job.title}</h4>
                                            <span class="text-xs font-medium text-slate-500 whitespace-nowrap">${job.startDate} — ${job.endDate}</span>
                                        </div>
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm font-semibold accent-color">${job.company}</span>
                                            <span class="text-xs text-slate-500 italic">${job.location}</span>
                                        </div>
                                        <p class="text-sm text-slate-700 leading-relaxed whitespace-pre-line">${job.description}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </section>
                    ` : ''}
                    
                    <!-- Education -->
                    ${edu.length > 0 ? `
                        <section>
                            <h3 class="text-sm font-bold uppercase tracking-wider text-slate-500 border-b border-slate-200 mb-4 pb-1">Education</h3>
                            <div class="space-y-4">
                                ${edu.map(ed => `
                                    <div>
                                        <div class="flex justify-between items-baseline mb-1">
                                            <h4 class="font-bold text-slate-800">${ed.school}</h4>
                                            <span class="text-xs font-medium text-slate-500 whitespace-nowrap">${ed.startDate} — ${ed.endDate}</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm text-slate-700">${ed.degree}</span>
                                            <span class="text-xs text-slate-500 italic">${ed.location}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </section>
                    ` : ''}
                    
                    <!-- Skills & Languages (Side-by-Side if space allows, stacked on mobile) -->
                    <section class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <!-- Skills -->
                        ${skills.length > 0 && skills[0] !== '' ? `
                            <div>
                                <h3 class="text-sm font-bold uppercase tracking-wider text-slate-500 border-b border-slate-200 mb-3 pb-1">Skills</h3>
                                <div class="flex flex-wrap gap-x-2 gap-y-1 text-sm text-slate-700">
                                    ${skills.map((skill) => `
                                        <span class="px-2 py-0.5 rounded bg-slate-100 print:bg-transparent print:p-0 print:border-none print:shadow-none">${skill}</span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Languages -->
                        ${languages.length > 0 ? `
                            <div>
                                <h3 class="text-sm font-bold uppercase tracking-wider text-slate-500 border-b border-slate-200 mb-3 pb-1">Languages</h3>
                                <ul class="text-sm space-y-1">
                                    ${languages.map(lang => `
                                        <li class="flex justify-between">
                                            <span class="font-medium">${lang.name}</span>
                                            <span class="text-slate-600 italic">${lang.level}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </section>
                </div>
            `;
            
            document.getElementById('cv-preview').innerHTML = html;
            lucide.createIcons();
        }

        // --- Helpers for inputs ---
        function createInput(label, key, value, placeholder = '') {
            return `
                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">${label}</label>
                    <input type="text" value="${value}" placeholder="${placeholder}" oninput="handlePersonalChange(this, '${key}')"
                        class="w-full rounded-lg border-slate-300 border p-2 text-sm focus:ring-2 ring-accent focus:border-transparent outline-none transition-all"
                    />
                </div>
            `;
        }

        function createArrayInput(section, id, label, field, value, placeholder = '') {
            return `
                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">${label}</label>
                    <input type="text" value="${value}" placeholder="${placeholder}" oninput="handleArrayChange('${section}', ${id}, '${field}', this.value)"
                        class="w-full rounded-lg border-slate-300 border p-2 text-sm focus:ring-2 ring-accent focus:border-transparent outline-none transition-all"
                    />
                </div>
            `;
        }

        // --- Event Handlers ---

        function handlePersonalChange(input, key) {
            state.data.personal[key] = input.value;
            renderPreview();
        }

        function handleArrayChange(section, id, field, value) {
            const index = state.data[section].findIndex(item => item.id === id);
            if (index !== -1) {
                state.data[section][index][field] = value;
                renderPreview();
            }
        }
        
        function handleThemeChange(color) {
            state.data.themeColor = color;
            applyTheme();
            switchTab(state.activeSection); // Re-render to apply color to buttons/icons
        }

        function handlePhotoUpload(file) {
            if (!file) {
                state.data.photoUrl = '';
                renderApp();
                return;
            }

            // Create a temporary URL for immediate preview
            const tempUrl = URL.createObjectURL(file);
            state.data.photoUrl = tempUrl;
            renderApp();
        }

        function removePhoto() {
            state.data.photoUrl = '';
            renderApp();
        }

        function handleSkillsChange(input) {
            state.data.skills = input.value.split(',').map(s => s.trim());
            renderPreview();
        }

        function addItem(section) {
            let newItem = { id: Date.now() };

            if (section === 'experience') {
                newItem = { ...newItem, title: '', company: '', location: '', startDate: '', endDate: '', description: '' };
            } else if (section === 'education') {
                newItem = { ...newItem, school: '', degree: '', location: '', startDate: '', endDate: '' };
            } else if (section === 'languages') {
                newItem = { ...newItem, name: '', level: '' };
            }
            
            // Note: 'projects' is no longer a valid section for adding items.

            state.data[section].unshift(newItem); // Add to top
            renderEditor();
            renderPreview();
            lucide.createIcons();
        }

        function removeItem(section, id) {
            state.data[section] = state.data[section].filter(item => item.id !== id);
            renderEditor();
            renderPreview();
            lucide.createIcons();
        }

        // Initialize
        renderApp();
    </script>
</body>
</html>

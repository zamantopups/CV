<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern CV Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* Custom styles to mimic the dark column and paper look */
        .cv-container {
            /* CORRECTED: A4 size (21.0cm x 29.7cm) */
            width: 21.0cm; 
            min-height: 29.7cm; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background-color: white;
            display: grid;
            grid-template-columns: 35% 65%; /* Two-column layout ratio from image */
        }

        .dark-column {
            background-color: #384252; /* Darker blue/grey */
            color: white;
        }

        .main-column h2 {
            border-bottom: 2px solid #384252;
            padding-bottom: 0.25rem;
            margin-bottom: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: #384252;
        }
        .main-column h3 {
             font-size: 1.125rem;
             font-weight: 700;
             color: #384252;
        }
        .text-accent {
            color: #A3B1C5; /* Light accent color for titles/subtitles */
        }

        /* Responsive stack for mobile */
        @media (max-width: 1024px) {
            .cv-container {
                width: 100%;
                min-height: auto;
                grid-template-columns: 1fr;
            }
        }

        /* Utility for the bullet points in work experience */
        .work-bullet::before {
            content: '•';
            margin-right: 8px;
            color: #384252;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        /* PRINT STYLES: Ensure only the CV container is visible and styled for A4 */
        @media print {
            body {
                background-color: white !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            /* Hide the editor column and surrounding elements when printing */
            .max-w-7xl, .editor-form {
                display: none !important;
            }
            .cv-preview {
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                justify-content: flex-start;
                align-items: flex-start;
            }
            .cv-container {
                width: 21.0cm; 
                min-height: 29.7cm; 
                box-shadow: none !important; /* Remove shadow for printing */
                margin: 0 auto;
                background-color: white !important;
            }
        }

    </style>
</head>
<body class="p-4 lg:p-8">

    <!-- Loading Indicator -->
    <div id="loadingOverlay" class="loading-overlay">
        <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-gray-700">Connecting to database...</p>
    </div>

    <div class="max-w-7xl mx-auto flex flex-col lg:flex-row space-y-6 lg:space-y-0 lg:space-x-6">
        
        <!-- Editor Column (Left/Top) -->
        <div id="editorFormContainer" class="editor-form w-full lg:w-1/2 p-6 bg-white rounded-xl shadow-lg h-full transition-all">
            <h1 class="text-3xl font-bold text-gray-800 mb-4 border-b pb-2">CV Data Editor</h1>

            <!-- NEW CONTROL BUTTONS (Print and Toggle Preview) -->
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mb-6">
                <button type="button" onclick="window.print()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-150 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-5a2 2 0 00-2-2H5a2 2 0 00-2 2v5a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zM7 13h10M7 5h10"/></svg>
                    Print CV (A4)
                </button>
                <!-- This button toggles between Editor and Preview on mobile/tablet (hidden on large screens) -->
                <button id="toggleViewButton" type="button" onclick="window.toggleView('toggle')" class="lg:hidden flex-1 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-150 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                    View CV Preview
                </button>
            </div>
            <!-- END NEW CONTROL BUTTONS -->

            <form id="cv-editor-form" class="space-y-6">

                <!-- Personal Info -->
                <fieldset class="p-4 border border-gray-200 rounded-lg">
                    <legend class="text-lg font-semibold text-indigo-600 px-2">Personal Info</legend>
                    <input type="text" data-field="name" placeholder="Your Name" class="input-field">
                    <input type="text" data-field="title" placeholder="Professional Title (e.g., Software Engineer)" class="input-field">
                    <textarea data-field="profile" placeholder="Profile Summary (1-3 sentences)" rows="4" class="input-field"></textarea>
                    <input type="text" data-field="contact.phone" placeholder="Phone Number" class="input-field">
                    <input type="email" data-field="contact.email" placeholder="Email Address" class="input-field">
                    <input type="text" data-field="contact.address" placeholder="Address / Location" class="input-field">
                    <input type="url" data-field="imageUrl" placeholder="Profile Image URL (Optional)" class="input-field">
                </fieldset>

                <!-- Dynamic Array Fields -->
                <div id="skills-section" class="dynamic-section p-4 border border-gray-200 rounded-lg">
                    <h3 class="font-semibold text-lg text-indigo-600 mb-2">Skills</h3>
                    <div id="skills-list" class="space-y-2"></div>
                    <button type="button" onclick="addItem('skills')" class="mt-2 text-sm bg-green-500 hover:bg-green-600 text-white py-1 px-3 rounded-md transition duration-150 shadow-md">Add Skill</button>
                </div>

                <div id="languages-section" class="dynamic-section p-4 border border-gray-200 rounded-lg">
                    <h3 class="font-semibold text-lg text-indigo-600 mb-2">Languages</h3>
                    <div id="languages-list" class="space-y-2"></div>
                    <button type="button" onclick="addItem('languages')" class="mt-2 text-sm bg-green-500 hover:bg-green-600 text-white py-1 px-3 rounded-md shadow-md transition duration-150">Add Language</button>
                </div>

                <div id="hobbies-section" class="dynamic-section p-4 border border-gray-200 rounded-lg">
                    <h3 class="font-semibold text-lg text-indigo-600 mb-2">Hobbies</h3>
                    <div id="hobbies-list" class="space-y-2"></div>
                    <button type="button" onclick="addItem('hobbies')" class="mt-2 text-sm bg-green-500 hover:bg-green-600 text-white py-1 px-3 rounded-md shadow-md transition duration-150">Add Hobby</button>
                </div>

                <div id="education-section" class="dynamic-section p-4 border border-gray-200 rounded-lg">
                    <h3 class="font-semibold text-lg text-indigo-600 mb-2">Education</h3>
                    <div id="education-list" class="space-y-4"></div>
                    <button type="button" onclick="addItem('education')" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded-md shadow-md transition duration-150">Add Education</button>
                </div>

                <div id="work-experience-section" class="dynamic-section p-4 border border-gray-200 rounded-lg">
                    <h3 class="font-semibold text-lg text-indigo-600 mb-2">Work Experience</h3>
                    <div id="work-experience-list" class="space-y-6"></div>
                    <button type="button" onclick="addItem('workExperience')" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded-md shadow-md transition duration-150">Add Work Experience</button>
                </div>
            </form>
        </div>

        <!-- CV Preview Column (Right/Bottom) -->
        <div id="cvPreviewContainer" class="cv-preview w-full lg:w-1/2 flex justify-center items-start pt-6 lg:pt-0">
            <div id="cv-content" class="cv-container rounded-lg transition-all">
                <!-- Content will be rendered here by JavaScript -->
            </div>
        </div>

    </div>

    <!-- Firebase Imports and Setup -->
    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL CONFIGS AND INITIALIZATION ---
        setLogLevel('error');
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let userId = null;
        let isAuthReady = false;
        let cvData = {};
        let saveTimeout;
        let currentView = 'editor'; // Track current state for mobile

        // Default CV Structure
        const defaultCV = {
            name: "Your Name",
            title: "Software Engineer",
            profile: "I am a software engineer with experience in a variety of programming languages and a track record of delivering high-quality code. I am skilled in problem-solving and have a strong background in computer science. I am a strong communicator and enjoy working collaboratively with others.",
            contact: {
                phone: "+1 2345 6789",
                email: "example@gmail.com",
                address: "#1 road, city/state-0011"
            },
            skills: [
                "SQL Database Management",
                "Linux/Unix Command line",
                "Python",
                "C++",
                "JAVA"
            ],
            languages: [
                { name: "English", proficiency: "Proficient" },
                { name: "Spanish", proficiency: "Intermediate" }
            ],
            hobbies: [
                "Writing",
                "Cricket",
                "Music"
            ],
            workExperience: [
                {
                    title: "Senior Software Developer",
                    company: "Company - Country",
                    dates: "Jan 2022 - Dec 2023",
                    bullets: [
                        "Developed and maintained software using Java, Python, and C++.",
                        "Led cross-functional teams to deliver successful software projects.",
                        "Wrote detailed technical specifications and documentation."
                    ]
                }
            ],
            education: [
                {
                    degree: "Masters in Software Engineering",
                    institution: "XYX University, Bangalore",
                    dates: "Jan 2019 - Dec 2020"
                }
            ],
            imageUrl: ""
        };

        // --- FIREBASE HELPER ---
        const getCvDocRef = (userId) => doc(db, 'artifacts', appId, 'users', userId, 'cvData', 'data');

        // --- DATA BINDING & PERSISTENCE ---

        // Debounced save function
        function debounceSave(data) {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                if (userId && isAuthReady) {
                    setDoc(getCvDocRef(userId), data, { merge: true })
                        .catch(err => console.error("Error saving data:", err));
                }
            }, 500); // Wait 500ms after last input before saving
        }

        // Handle general input changes (non-array fields)
        function handleInput(event) {
            const field = event.target.dataset.field;
            const value = event.target.value;
            if (!field) return;

            // Simple dot-notation setter for nested objects
            const parts = field.split('.');
            let current = cvData;
            for (let i = 0; i < parts.length - 1; i++) {
                if (!current[parts[i]]) current[parts[i]] = {};
                current = current[parts[i]];
            }
            current[parts[parts.length - 1]] = value;

            debounceSave(cvData);
        }

        // Handle array item changes (skills, hobbies, etc.)
        function handleArrayItemChange(type, index, field, value) {
            if (field === 'item') {
                cvData[type][index] = value;
            } else {
                // For objects in array (like languages/education/workExperience)
                if (!cvData[type][index]) {
                    if (type === 'languages') cvData[type][index] = { name: '', proficiency: '' };
                    else if (type === 'education') cvData[type][index] = { degree: '', institution: '', dates: '' };
                    else if (type === 'workExperience') cvData[type][index] = { title: '', company: '', dates: '', bullets: [''] };
                }
                cvData[type][index][field] = value;
            }
            debounceSave(cvData);
        }

        // Handle work experience bullet point changes
        function handleBulletChange(workIndex, bulletIndex, value) {
            cvData.workExperience[workIndex].bullets[bulletIndex] = value;
            debounceSave(cvData);
        }
        
        function addBullet(workIndex) {
            cvData.workExperience[workIndex].bullets.push("");
            debounceSave(cvData);
            // After saving, the onSnapshot listener will re-render everything
        }

        function removeBullet(workIndex, bulletIndex) {
            cvData.workExperience[workIndex].bullets.splice(bulletIndex, 1);
            debounceSave(cvData);
        }

        // --- UI RENDER FUNCTIONS ---

        function renderForm(data) {
            // Render Simple Fields (Name, Title, Profile, Contact)
            document.querySelectorAll('#cv-editor-form input, #cv-editor-form textarea').forEach(input => {
                const field = input.dataset.field;
                if (!field) return;

                const parts = field.split('.');
                let value = data;
                for (const part of parts) {
                    value = value ? value[part] : '';
                }
                // Only set value if it's different to prevent cursor jump
                if (input.value !== value) {
                    input.value = value || '';
                }
            });

            // Render Dynamic Arrays (Skills, Hobbies)
            ['skills', 'hobbies'].forEach(type => {
                const listEl = document.getElementById(`${type}-list`);
                if (!listEl) return;
                listEl.innerHTML = data[type]?.map((item, index) => `
                    <div class="flex space-x-2">
                        <input type="text" value="${item}" oninput="window.handleArrayItemChange('${type}', ${index}, 'item', this.value)" placeholder="${type === 'skills' ? 'Skill name' : 'Hobby name'}" class="input-field flex-grow">
                        <button type="button" onclick="window.removeItem('${type}', ${index})" class="text-red-500 hover:text-red-700 p-2 rounded-full transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                `).join('') || '';
            });

            // Render Languages
            const langListEl = document.getElementById('languages-list');
            langListEl.innerHTML = data.languages?.map((lang, index) => `
                <div class="p-3 border border-gray-100 rounded-lg space-y-1">
                    <div class="flex items-center space-x-2">
                        <input type="text" value="${lang.name}" oninput="window.handleArrayItemChange('languages', ${index}, 'name', this.value)" placeholder="Language Name" class="input-field flex-grow">
                        <select onchange="window.handleArrayItemChange('languages', ${index}, 'proficiency', this.value)" class="input-field w-1/3">
                            ${['Beginner', 'Intermediate', 'Proficient', 'Native'].map(p => 
                                `<option value="${p}" ${lang.proficiency === p ? 'selected' : ''}>${p}</option>`
                            ).join('')}
                        </select>
                        <button type="button" onclick="window.removeItem('languages', ${index})" class="text-red-500 hover:text-red-700 p-2 rounded-full transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
            `).join('') || '';

            // Render Education
            const eduListEl = document.getElementById('education-list');
            eduListEl.innerHTML = data.education?.map((edu, index) => `
                <div class="p-3 border border-gray-100 rounded-lg space-y-2">
                    <input type="text" value="${edu.degree}" oninput="window.handleArrayItemChange('education', ${index}, 'degree', this.value)" placeholder="Degree/Major" class="input-field">
                    <input type="text" value="${edu.institution}" oninput="window.handleArrayItemChange('education', ${index}, 'institution', this.value)" placeholder="University/Institution" class="input-field">
                    <div class="flex items-center space-x-2">
                        <input type="text" value="${edu.dates}" oninput="window.handleArrayItemChange('education', ${index}, 'dates', this.value)" placeholder="Dates (e.g., Jan 2019 - Dec 2020)" class="input-field flex-grow">
                        <button type="button" onclick="window.removeItem('education', ${index})" class="text-red-500 hover:text-red-700 p-2 rounded-full transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
            `).join('') || '';

            // Render Work Experience
            const workListEl = document.getElementById('work-experience-list');
            workListEl.innerHTML = data.workExperience?.map((work, index) => `
                <div class="p-3 border border-gray-100 rounded-lg space-y-2">
                    <input type="text" value="${work.title}" oninput="window.handleArrayItemChange('workExperience', ${index}, 'title', this.value)" placeholder="Job Title" class="input-field">
                    <div class="flex space-x-2">
                        <input type="text" value="${work.company}" oninput="window.handleArrayItemChange('workExperience', ${index}, 'company', this.value)" placeholder="Company - Location" class="input-field flex-grow">
                        <input type="text" value="${work.dates}" oninput="window.handleArrayItemChange('workExperience', ${index}, 'dates', this.value)" placeholder="Dates (e.g., Jan 2022 - Dec 2023)" class="input-field w-1/3">
                    </div>
                    <div class="mt-2 space-y-1 p-2 bg-gray-50 rounded-md">
                        <h4 class="font-medium text-sm text-gray-700">Bullet Points:</h4>
                        ${work.bullets.map((bullet, bIndex) => `
                            <div class="flex items-center space-x-2">
                                <span class="text-gray-500">•</span>
                                <input type="text" value="${bullet}" oninput="window.handleBulletChange(${index}, ${bIndex}, this.value)" placeholder="Key achievement or responsibility" class="input-field flex-grow text-sm">
                                <button type="button" onclick="window.removeBullet(${index}, ${bIndex})" class="text-red-400 hover:text-red-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        `).join('')}
                        <button type="button" onclick="window.addBullet(${index})" class="mt-1 text-xs text-indigo-500 hover:text-indigo-700 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            Add Bullet
                        </button>
                    </div>
                    <button type="button" onclick="window.removeItem('workExperience', ${index})" class="mt-2 text-sm bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded-md shadow-md transition duration-150">Remove Job</button>
                </div>
            `).join('') || '';
        }

        function renderCV(data) {
            const cvContent = document.getElementById('cv-content');
            
            // Generate Avatar HTML
            let avatarHtml;
            if (data.imageUrl) {
                avatarHtml = `<img src="${data.imageUrl}" onerror="this.onerror=null;this.src='https://placehold.co/150x150/384252/ffffff?text=Image+Error'" class="w-40 h-40 object-cover rounded-full border-4 border-white mx-auto mb-4" alt="Profile Picture">`;
            } else {
                const initials = (data.name || 'NN').split(' ').map(n => n[0]).slice(0, 2).join('').toUpperCase();
                avatarHtml = `
                    <div class="w-40 h-40 rounded-full border-4 border-white mx-auto mb-4 flex items-center justify-center text-6xl font-extrabold bg-gray-500">
                        ${initials}
                    </div>
                `;
            }

            cvContent.innerHTML = `
                <!-- Dark Column (Left) -->
                <div class="dark-column p-8 space-y-8">
                    
                    <!-- Avatar -->
                    <div class="text-center">
                        ${avatarHtml}
                    </div>

                    <!-- Name & Title -->
                    <div class="text-center mb-6">
                        <h1 class="text-3xl font-bold text-white mb-1">${data.name || 'Your Name'}</h1>
                        <p class="text-lg font-medium text-accent">${data.title || 'Professional Title'}</p>
                    </div>

                    <!-- Contact -->
                    <div class="pt-4 border-t border-gray-600">
                        <h3 class="text-xl font-bold mb-3 text-white">CONTACT</h3>
                        <div class="space-y-2 text-sm">
                            <p class="flex items-center"><span class="mr-3 text-accent text-xl">&#9742;</span> ${data.contact.phone || '+1 2345 6789'}</p>
                            <p class="flex items-center"><span class="mr-3 text-accent text-xl">&#9993;</span> ${data.contact.email || 'example@gmail.com'}</p>
                            <p class="flex items-center"><span class="mr-3 text-accent text-xl">&#128205;</span> ${data.contact.address || '#1 road, city/state-0011'}</p>
                        </div>
                    </div>

                    <!-- Skills -->
                    <div class="pt-4 border-t border-gray-600">
                        <h3 class="text-xl font-bold mb-3 text-white">SKILLS</h3>
                        <ul class="list-disc ml-4 space-y-1 text-sm">
                            ${data.skills?.map(s => `<li>${s}</li>`).join('') || '<li>No skills added</li>'}
                        </ul>
                    </div>

                    <!-- Languages -->
                    <div class="pt-4 border-t border-gray-600">
                        <h3 class="text-xl font-bold mb-3 text-white">LANGUAGES</h3>
                        <div class="space-y-1">
                            ${data.languages?.map(l => `
                                <p><span class="font-semibold text-accent">${l.name}:</span> ${l.proficiency}</p>
                            `).join('') || '<p>No languages added</p>'}
                        </div>
                    </div>

                    <!-- Hobbies -->
                    <div class="pt-4 border-t border-gray-600">
                        <h3 class="text-xl font-bold mb-3 text-white">HOBBIES</h3>
                        <ul class="list-disc ml-4 space-y-1 text-sm">
                            ${data.hobbies?.map(h => `<li>${h}</li>`).join('') || '<li>No hobbies added</li>'}
                        </ul>
                    </div>
                </div>

                <!-- Main Column (Right) -->
                <div class="main-column p-8 space-y-8 text-gray-800">

                    <!-- Profile -->
                    <section>
                        <h2>PROFILE</h2>
                        <p class="text-base leading-relaxed">${data.profile || 'Write a brief, compelling summary of your professional experience and goals here.'}</p>
                    </section>

                    <!-- Work Experience -->
                    <section>
                        <h2>WORK EXPERIENCE</h2>
                        <div class="space-y-6">
                            ${data.workExperience?.map(work => `
                                <div>
                                    <div class="flex justify-between items-start mb-1">
                                        <h3 class="font-semibold text-lg">${work.title || 'Job Title'}</h3>
                                        <p class="text-sm font-medium text-gray-500">${work.dates || 'Dates'}</p>
                                    </div>
                                    <p class="text-sm font-medium italic mb-2">${work.company || 'Company - Country'}</p>
                                    <ul class="list-none ml-0 space-y-1 text-sm">
                                        ${work.bullets?.map(bullet => `
                                            <li class="flex items-start">
                                                <span class="work-bullet mt-1"></span>
                                                <span class="flex-1">${bullet}</span>
                                            </li>
                                        `).join('') || ''}
                                    </ul>
                                </div>
                            `).join('') || '<p class="text-gray-500">Add your work experience details.</p>'}
                        </div>
                    </section>

                    <!-- Education -->
                    <section>
                        <h2>EDUCATION</h2>
                        <div class="space-y-4">
                            ${data.education?.map(edu => `
                                <div>
                                    <div class="flex justify-between items-start mb-1">
                                        <h3 class="font-semibold">${edu.degree || 'Degree'}</h3>
                                        <p class="text-sm font-medium text-gray-500">${edu.dates || 'Dates'}</p>
                                    </div>
                                    <p class="text-sm italic">${edu.institution || 'University/Institution'}</p>
                                </div>
                            `).join('') || '<p class="text-gray-500">Add your education history.</p>'}
                        </div>
                    </section>
                </div>
            `;
        }

        // --- DYNAMIC ARRAY MUTATORS ---

        window.addItem = function(type) {
            if (!cvData[type]) cvData[type] = [];
            
            if (type === 'languages') {
                cvData[type].push({ name: '', proficiency: 'Beginner' });
            } else if (type === 'education') {
                cvData[type].push({ degree: '', institution: '', dates: '' });
            } else if (type === 'workExperience') {
                cvData[type].push({ title: '', company: '', dates: '', bullets: [''] });
            } else {
                // skills, hobbies (simple strings)
                cvData[type].push("");
            }
            debounceSave(cvData);
        }

        window.removeItem = function(type, index) {
            cvData[type].splice(index, 1);
            debounceSave(cvData);
        }

        // Expose to global scope for use in oninput/onclick attributes
        window.handleArrayItemChange = handleArrayItemChange;
        window.handleBulletChange = handleBulletChange;
        window.addBullet = addBullet;
        window.removeBullet = removeBullet;
        // window.toggleView is now below

        // --- MOBILE/VIEW TOGGLE ---
        window.toggleView = function(view) {
            const editorContainer = document.getElementById('editorFormContainer');
            const previewContainer = document.getElementById('cvPreviewContainer');
            const toggleButton = document.getElementById('toggleViewButton');

            if (view === 'editor' || (view === 'toggle' && currentView === 'preview')) {
                // Switch to Editor View
                editorContainer.classList.remove('hidden');
                previewContainer.classList.add('hidden');
                if (toggleButton) {
                    toggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>View CV Preview`;
                }
                currentView = 'editor';
            } else if (view === 'preview' || (view === 'toggle' && currentView === 'editor')) {
                // Switch to Preview View
                editorContainer.classList.add('hidden');
                previewContainer.classList.remove('hidden');
                if (toggleButton) {
                    toggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>Edit Data`;
                }
                currentView = 'preview';
            }
        }


        // --- AUTHENTICATION AND DATA SYNC ---
        async function initAuthAndData() {
            try {
                // 1. Authenticate
                const authPromise = initialAuthToken 
                    ? signInWithCustomToken(auth, initialAuthToken)
                    : signInAnonymously(auth);

                await authPromise;
                userId = auth.currentUser.uid;
                isAuthReady = true;

                // 2. Set up Real-time Listener (onSnapshot)
                const docRef = getCvDocRef(userId);
                
                onSnapshot(docRef, (docSnap) => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    
                    if (docSnap.exists()) {
                        // Data retrieved from Firestore
                        cvData = { ...defaultCV, ...docSnap.data() };
                        console.log("Data loaded from Firestore.");
                    } else {
                        // No data exists, write default data and use it
                        console.log("No data found. Saving default CV data.");
                        cvData = defaultCV;
                        setDoc(docRef, defaultCV).catch(err => console.error("Error setting default data:", err));
                    }
                    
                    // 3. Render UI with latest data
                    renderForm(cvData);
                    renderCV(cvData);
                }, (error) => {
                    console.error("Error listening to data:", error);
                    // Fallback to default data if listener fails
                    cvData = defaultCV;
                    renderForm(cvData);
                    renderCV(cvData);
                    document.getElementById('loadingOverlay').classList.add('hidden');
                });
                
                // Add listener for all simple inputs
                document.getElementById('cv-editor-form').addEventListener('input', handleInput);

                // Initial view setup for mobile
                if (window.innerWidth < 1024) {
                    // Start in editor view on mobile
                    window.toggleView('editor'); 
                }

            } catch (error) {
                console.error("Authentication or Initialization Error:", error);
                document.getElementById('loadingOverlay').classList.add('hidden');
                // Show default data if auth fails completely
                cvData = defaultCV;
                renderForm(cvData);
                renderCV(cvData);
            }
        }

        initAuthAndData();

    </script>
    <script>
        // Use a simple retry mechanism for the fetch call.
        async function fetchWithRetry(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response;
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern CV Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* Custom styles to mimic the dark column and paper look */
        .cv-container {
            /* A4 size (21.0cm x 29.7cm) */
            width: 21.0cm; 
            min-height: 29.7cm; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background-color: white;
            display: grid;
            grid-template-columns: 35% 65%; /* Two-column layout ratio from image */
        }

        .dark-column {
            background-color: #384252; /* Darker blue/grey */
            color: white;
        }

        .main-column h2 {
            border-bottom: 2px solid #384252;
            padding-bottom: 0.25rem;
            margin-bottom: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: #384252;
        }
        .main-column h3 {
             font-size: 1.125rem;
             font-weight: 700;
             color: #384252;
        }
        .text-accent {
            color: #A3B1C5; /* Light accent color for titles/subtitles */
        }

        /* Responsive stack for mobile */
        @media (max-width: 1024px) {
            .cv-container {
                width: 100%;
                min-height: auto;
                grid-template-columns: 1fr;
            }
            .cv-preview {
                display: none; /* Hidden by default on small screens */
            }
            .editor-form {
                display: block; /* Visible by default on small screens */
            }
            /* Toggle classes for view switching */
            .show-preview-on-mobile .cv-preview {
                display: flex !important;
            }
            .show-preview-on-mobile .editor-form {
                display: none !important;
            }
        }
        
        /* Utility for the bullet points in work experience */
        .work-bullet::before {
            content: '•';
            margin-right: 8px;
            color: #384252;
        }
        
        /* PRINT STYLES: Ensure only the CV container is visible and styled for A4 */
        @media print {
            /* General body and page reset */
            body {
                background-color: white !important;
                padding: 0 !important;
                margin: 0 !important;
                /* Ensure all elements are visible by default in print */
                visibility: visible !important;
                overflow: visible !important;
            }

            /* Hide the editor column and surrounding elements when printing */
            .max-w-7xl, 
            .editor-form {
                display: none !important;
                visibility: hidden !important; /* Explicitly hide the editor */
            }

            /* Ensure the CV preview container is visible and takes up the space */
            .cv-preview {
                display: block !important;
                visibility: visible !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                justify-content: flex-start !important;
                align-items: flex-start !important;
                /* Reset mobile view state if active */
                position: static !important;
                left: 0 !important;
                top: 0 !important;
            }

            /* Ensure the main CV container is properly sized and styled */
            .cv-container {
                width: 21.0cm !important; 
                min-height: 29.7cm !important; 
                box-shadow: none !important; /* Remove shadow for printing */
                margin: 0 auto !important;
                background-color: white !important;
                display: grid !important; /* Restore grid layout */
                grid-template-columns: 35% 65% !important; /* Restore columns */
            }

            /* --- FIX FOR BLACK PRINT PREVIEW & Readability --- */
            .cv-container .dark-column {
                background-color: white !important; /* Set dark column background to white */
                color: #333 !important; /* Set text color to dark grey/black */
            }
            .cv-container .dark-column h1, 
            .cv-container .dark-column h3 {
                color: #384252 !important; /* Ensure headers are dark and visible */
            }
            .cv-container .dark-column .text-accent {
                color: #6B7280 !important; /* Ensure accent text is also dark */
            }
            .cv-container .dark-column .border-t {
                border-color: #E5E7EB !important; /* Lighten borders */
            }
            /* --- END PRINT FIX --- */
        }

    </style>
</head>
<body class="p-4 lg:p-8">

    <div class="max-w-7xl mx-auto flex flex-col lg:flex-row space-y-6 lg:space-y-0 lg:space-x-6">
        
        <!-- Editor Column (Left/Top) -->
        <div id="editorFormContainer" class="editor-form w-full lg:w-1/2 p-6 bg-white rounded-xl shadow-lg h-full transition-all">
            <h1 class="text-3xl font-bold text-gray-800 mb-4 border-b pb-2">CV Data Editor</h1>

            <!-- NEW CONTROL BUTTONS (Print and Toggle Preview) -->
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mb-6">
                <button type="button" onclick="window.print()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-150 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-5a2 2 0 00-2-2H5a2 2 0 00-2 2v5a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zM7 13h10M7 5h10"/></svg>
                    Print CV (A4)
                </button>
                <!-- This button toggles between Editor and Preview on mobile/tablet (hidden on large screens) -->
                <button id="toggleViewButton" type="button" onclick="window.toggleView('toggle')" class="lg:hidden flex-1 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-150 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                    View CV Preview
                </button>
            </div>
            <!-- END NEW CONTROL BUTTONS -->

            <form id="cv-editor-form" class="space-y-6">

                <!-- Personal Info -->
                <fieldset class="p-4 border border-gray-200 rounded-lg">
                    <legend class="text-lg font-semibold text-indigo-600 px-2">Personal Info</legend>
                    <input type="text" data-field="name" placeholder="Your Name" class="input-field">
                    <input type="text" data-field="title" placeholder="Professional Title (e.g., Software Engineer)" class="input-field">
                    <textarea data-field="profile" placeholder="Profile Summary (1-3 sentences)" rows="4" class="input-field"></textarea>
                    <input type="text" data-field="contact.phone" placeholder="Phone Number" class="input-field">
                    <input type="email" data-field="contact.email" placeholder="Email Address" class="input-field">
                    <input type="text" data-field="contact.address" placeholder="Address / Location" class="input-field">
                    <input type="url" data-field="imageUrl" placeholder="Profile Image URL (Optional)" class="input-field">
                </fieldset>

                <!-- Dynamic Array Fields -->
                <div id="skills-section" class="dynamic-section p-4 border border-gray-200 rounded-lg">
                    <h3 class="font-semibold text-lg text-indigo-600 mb-2">Skills</h3>
                    <div id="skills-list" class="space-y-2"></div>
                    <button type="button" onclick="addItem('skills')" class="mt-2 text-sm bg-green-500 hover:bg-green-600 text-white py-1 px-3 rounded-md shadow-md transition duration-150">Add Skill</button>
                </div>

                <div id="languages-section" class="dynamic-section p-4 border border-gray-200 rounded-lg">
                    <h3 class="font-semibold text-lg text-indigo-600 mb-2">Languages</h3>
                    <div id="languages-list" class="space-y-2"></div>
                    <button type="button" onclick="addItem('languages')" class="mt-2 text-sm bg-green-500 hover:bg-green-600 text-white py-1 px-3 rounded-md shadow-md transition duration-150">Add Language</button>
                </div>

                <div id="hobbies-section" class="dynamic-section p-4 border border-gray-200 rounded-lg">
                    <h3 class="font-semibold text-lg text-indigo-600 mb-2">Hobbies</h3>
                    <div id="hobbies-list" class="space-y-2"></div>
                    <button type="button" onclick="addItem('hobbies')" class="mt-2 text-sm bg-green-500 hover:bg-green-600 text-white py-1 px-3 rounded-md shadow-md transition duration-150">Add Hobby</button>
                </div>

                <div id="education-section" class="dynamic-section p-4 border border-gray-200 rounded-lg">
                    <h3 class="font-semibold text-lg text-indigo-600 mb-2">Education</h3>
                    <div id="education-list" class="space-y-4"></div>
                    <button type="button" onclick="addItem('education')" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded-md shadow-md transition duration-150">Add Education</button>
                </div>

                <div id="work-experience-section" class="dynamic-section p-4 border border-gray-200 rounded-lg">
                    <h3 class="font-semibold text-lg text-indigo-600 mb-2">Work Experience</h3>
                    <div id="work-experience-list" class="space-y-6"></div>
                    <button type="button" onclick="addItem('workExperience')" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded-md shadow-md transition duration-150">Add Work Experience</button>
                </div>
            </form>
        </div>

        <!-- CV Preview Column (Right/Bottom) -->
        <div id="cvPreviewContainer" class="cv-preview w-full lg:w-1/2 flex justify-center items-start pt-6 lg:pt-0">
            <div id="cv-content" class="cv-container rounded-lg transition-all">
                <!-- Content will be rendered here by JavaScript -->
            </div>
        </div>

    </div>

    <!-- Application Script -->
    <script type="module">
        
        // --- GLOBAL CONFIGS AND INITIALIZATION ---
        
        let cvData = {};
        let saveTimeout;
        let currentView = 'editor'; // Track current state for mobile

        // Define the key for localStorage
        const STORAGE_KEY = 'cvBuilderData';

        // Default CV Structure
        const defaultCV = {
            name: "Your Name",
            title: "Software Engineer",
            profile: "I am a software engineer with experience in a variety of programming languages and a track record of delivering high-quality code. I am skilled in problem-solving and have a strong background in computer science. I am a strong communicator and enjoy working collaboratively with others.",
            contact: {
                phone: "+1 2345 6789",
                email: "example@gmail.com",
                address: "#1 road, city/state-0011"
            },
            skills: [
                "SQL Database Management",
                "Linux/Unix Command line",
                "Python",
                "C++",
                "JAVA"
            ],
            languages: [
                { name: "English", proficiency: "Proficient" },
                { name: "Spanish", proficiency: "Intermediate" }
            ],
            hobbies: [
                "Writing",
                "Cricket",
                "Music"
            ],
            workExperience: [
                {
                    title: "Senior Software Developer",
                    company: "Company - Country",
                    dates: "Jan 2022 - Dec 2023",
                    bullets: [
                        "Developed and maintained software using Java, Python, and C++.",
                        "Led cross-functional teams to deliver successful software projects.",
                        "Wrote detailed technical specifications and documentation."
                    ]
                }
            ],
            education: [
                {
                    degree: "Masters in Software Engineering",
                    institution: "XYX University, Bangalore",
                    dates: "Jan 2019 - Dec 2020"
                }
            ],
            imageUrl: ""
        };

        // --- DATA BINDING & PERSISTENCE (using localStorage) ---

        // Debounced save function to store data in localStorage
        function debounceSave(data) {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                    // console.log("Data saved to localStorage.");
                } catch (err) {
                    console.error("Error saving data to localStorage:", err);
                }
                // Re-render CV after saving data to ensure immediate UI update
                renderForm(cvData);
                renderCV(cvData);
            }, 300); // Wait 300ms after last input before saving
        }

        // Handle general input changes (non-array fields)
        function handleInput(event) {
            const field = event.target.dataset.field;
            const value = event.target.value;
            if (!field) return;

            // Simple dot-notation setter for nested objects
            const parts = field.split('.');
            let current = cvData;
            for (let i = 0; i < parts.length - 1; i++) {
                if (!current[parts[i]]) current[parts[i]] = {};
                current = current[parts[i]];
            }
            current[parts[parts.length - 1]] = value;

            debounceSave(cvData);
        }

        // Handle array item changes (skills, hobbies, etc.)
        function handleArrayItemChange(type, index, field, value) {
            if (!cvData[type]) return; // Should not happen if data is initialized

            if (field === 'item') {
                cvData[type][index] = value;
            } else {
                // For objects in array (like languages/education/workExperience)
                if (!cvData[type][index]) {
                    // Initialize structure if somehow missing (safety check)
                    if (type === 'languages') cvData[type][index] = { name: '', proficiency: '' };
                    else if (type === 'education') cvData[type][index] = { degree: '', institution: '', dates: '' };
                    else if (type === 'workExperience') cvData[type][index] = { title: '', company: '', dates: '', bullets: [''] };
                }
                cvData[type][index][field] = value;
            }
            debounceSave(cvData);
        }

        // Handle work experience bullet point changes
        function handleBulletChange(workIndex, bulletIndex, value) {
            if (!cvData.workExperience?.[workIndex]?.bullets) return;
            cvData.workExperience[workIndex].bullets[bulletIndex] = value;
            debounceSave(cvData);
        }
        
        function addBullet(workIndex) {
            if (!cvData.workExperience?.[workIndex]?.bullets) return;
            cvData.workExperience[workIndex].bullets.push("");
            debounceSave(cvData);
        }

        function removeBullet(workIndex, bulletIndex) {
            if (!cvData.workExperience?.[workIndex]?.bullets) return;
            cvData.workExperience[workIndex].bullets.splice(bulletIndex, 1);
            debounceSave(cvData);
        }

        // --- UI RENDER FUNCTIONS ---

        function renderForm(data) {
            // Render Simple Fields (Name, Title, Profile, Contact)
            document.querySelectorAll('#cv-editor-form input, #cv-editor-form textarea').forEach(input => {
                const field = input.dataset.field;
                if (!field) return;

                const parts = field.split('.');
                let value = data;
                for (const part of parts) {
                    value = value ? value[part] : '';
                }
                // Only set value if it's different to prevent cursor jump
                if (input.value !== value) {
                    input.value = value || '';
                }
            });

            // Render Dynamic Arrays (Skills, Hobbies)
            ['skills', 'hobbies'].forEach(type => {
                const listEl = document.getElementById(`${type}-list`);
                if (!listEl) return;
                listEl.innerHTML = data[type]?.map((item, index) => `
                    <div class="flex space-x-2">
                        <input type="text" value="${item}" oninput="window.handleArrayItemChange('${type}', ${index}, 'item', this.value)" placeholder="${type === 'skills' ? 'Skill name' : 'Hobby name'}" class="input-field flex-grow">
                        <button type="button" onclick="window.removeItem('${type}', ${index})" class="text-red-500 hover:text-red-700 p-2 rounded-full transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                `).join('') || '';
            });

            // Render Languages
            const langListEl = document.getElementById('languages-list');
            langListEl.innerHTML = data.languages?.map((lang, index) => `
                <div class="p-3 border border-gray-100 rounded-lg space-y-1">
                    <div class="flex items-center space-x-2">
                        <input type="text" value="${lang.name}" oninput="window.handleArrayItemChange('languages', ${index}, 'name', this.value)" placeholder="Language Name" class="input-field flex-grow">
                        <select onchange="window.handleArrayItemChange('languages', ${index}, 'proficiency', this.value)" class="input-field w-1/3">
                            ${['Beginner', 'Intermediate', 'Proficient', 'Native'].map(p => 
                                `<option value="${p}" ${lang.proficiency === p ? 'selected' : ''}>${p}</option>`
                            ).join('')}
                        </select>
                        <button type="button" onclick="window.removeItem('languages', ${index})" class="text-red-500 hover:text-red-700 p-2 rounded-full transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
            `).join('') || '';

            // Render Education
            const eduListEl = document.getElementById('education-list');
            eduListEl.innerHTML = data.education?.map((edu, index) => `
                <div class="p-4 border border-indigo-200 rounded-lg space-y-2 relative">
                    <input type="text" value="${edu.degree}" oninput="window.handleArrayItemChange('education', ${index}, 'degree', this.value)" placeholder="Degree/Certificate" class="input-field">
                    <input type="text" value="${edu.institution}" oninput="window.handleArrayItemChange('education', ${index}, 'institution', this.value)" placeholder="Institution Name, City" class="input-field">
                    <input type="text" value="${edu.dates}" oninput="window.handleArrayItemChange('education', ${index}, 'dates', this.value)" placeholder="Start Year - End Year" class="input-field">
                    <button type="button" onclick="window.removeItem('education', ${index})" class="absolute top-2 right-2 text-red-500 hover:text-red-700 p-1 rounded-full transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            `).join('') || '';


            // Render Work Experience
            const workListEl = document.getElementById('work-experience-list');
            workListEl.innerHTML = data.workExperience?.map((work, index) => `
                <div class="p-4 border border-purple-200 rounded-lg space-y-2 relative">
                    <input type="text" value="${work.title}" oninput="window.handleArrayItemChange('workExperience', ${index}, 'title', this.value)" placeholder="Job Title" class="input-field">
                    <div class="flex space-x-2">
                        <input type="text" value="${work.company}" oninput="window.handleArrayItemChange('workExperience', ${index}, 'company', this.value)" placeholder="Company Name" class="input-field flex-grow">
                        <input type="text" value="${work.dates}" oninput="window.handleArrayItemChange('workExperience', ${index}, 'dates', this.value)" placeholder="Dates (e.g., Jan 2022 - Dec 2023)" class="input-field w-1/3">
                    </div>

                    <h4 class="font-medium text-gray-700 mt-3 mb-1 text-sm">Achievements/Responsibilities:</h4>
                    <div class="space-y-1">
                        ${work.bullets?.map((bullet, bulletIndex) => `
                            <div class="flex space-x-2 items-center">
                                <span class="text-gray-500">•</span>
                                <input type="text" value="${bullet}" oninput="window.handleBulletChange(${index}, ${bulletIndex}, this.value)" placeholder="Key achievement/bullet point" class="input-field flex-grow text-sm">
                                <button type="button" onclick="window.removeBullet(${index}, ${bulletIndex})" class="text-red-400 hover:text-red-600 p-1 rounded-full transition duration-150">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <button type="button" onclick="window.addBullet(${index})" class="mt-2 text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 px-3 rounded-md transition duration-150">Add Bullet</button>

                    <button type="button" onclick="window.removeItem('workExperience', ${index})" class="absolute top-2 right-2 text-red-500 hover:text-red-700 p-1 rounded-full transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            `).join('') || '';
        }

        function renderCV(data) {
            const contentEl = document.getElementById('cv-content');
            
            // Generate the HTML for the dark column (Contact, Skills, Languages, Hobbies)
            const darkColumnHtml = `
                <div class="dark-column p-8 flex flex-col items-center text-center">
                    ${data.imageUrl ? `
                        <img src="${data.imageUrl}" onerror="this.onerror=null;this.src='https://placehold.co/120x120/A3B1C5/384252?text=Photo';" alt="Profile Picture" class="w-24 h-24 object-cover rounded-full mb-4 ring-4 ring-white shadow-xl">
                    ` : ''}
                    <h1 class="text-3xl font-extrabold mb-1">${data.name}</h1>
                    <p class="text-accent text-lg font-medium mb-8">${data.title}</p>

                    <!-- Contact -->
                    <div class="w-full text-left mb-6">
                        <h3 class="text-xl font-bold border-b border-white border-opacity-30 pb-1 mb-3">CONTACT</h3>
                        <p class="flex items-center text-sm mb-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.717 21 3 14.283 3 6V5z"/></svg>
                            ${data.contact?.phone}
                        </p>
                        <p class="flex items-center text-sm mb-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                            ${data.contact?.email}
                        </p>
                        <p class="flex items-center text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a2 2 0 01-2.828 0l-4.243-4.243m-4.04-1.442A8 8 0 1121.78 8.44L20 9.5 17.657 16.657z"/></svg>
                            ${data.contact?.address}
                        </p>
                    </div>

                    <!-- Skills -->
                    ${data.skills?.length > 0 ? `
                        <div class="w-full text-left mb-6">
                            <h3 class="text-xl font-bold border-b border-white border-opacity-30 pb-1 mb-3">SKILLS</h3>
                            <div class="flex flex-wrap gap-2">
                                ${data.skills.filter(s => s).map(skill => `<span class="bg-white text-gray-800 text-xs font-medium px-2 py-0.5 rounded">${skill}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Languages -->
                    ${data.languages?.length > 0 ? `
                        <div class="w-full text-left mb-6">
                            <h3 class="text-xl font-bold border-b border-white border-opacity-30 pb-1 mb-3">LANGUAGES</h3>
                            <ul class="text-sm space-y-1">
                                ${data.languages.filter(l => l.name).map(lang => `
                                    <li class="flex justify-between">
                                        <span class="font-medium">${lang.name}</span>
                                        <span class="text-accent">${lang.proficiency}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    <!-- Hobbies -->
                    ${data.hobbies?.length > 0 ? `
                        <div class="w-full text-left">
                            <h3 class="text-xl font-bold border-b border-white border-opacity-30 pb-1 mb-3">HOBBIES</h3>
                            <p class="text-sm">${data.hobbies.filter(h => h).join(', ')}</p>
                        </div>
                    ` : ''}
                </div>
            `;

            // Generate the HTML for the main column (Profile, Experience, Education)
            const mainColumnHtml = `
                <div class="main-column p-8">
                    <!-- Profile Summary -->
                    ${data.profile ? `
                        <section class="mb-8">
                            <h2>PROFILE</h2>
                            <p class="text-gray-600 leading-relaxed">${data.profile}</p>
                        </section>
                    ` : ''}

                    <!-- Work Experience -->
                    ${data.workExperience?.length > 0 ? `
                        <section class="mb-8">
                            <h2>WORK EXPERIENCE</h2>
                            <div class="space-y-6">
                                ${data.workExperience.map(work => `
                                    <div>
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <h3>${work.title}</h3>
                                                <p class="text-indigo-600 text-sm font-medium">${work.company}</p>
                                            </div>
                                            <span class="text-xs text-gray-500 font-semibold">${work.dates}</span>
                                        </div>
                                        <ul class="mt-2 list-none p-0 space-y-1 text-sm text-gray-600">
                                            ${work.bullets?.filter(b => b).map(bullet => `
                                                <li class="flex items-start">
                                                    <span class="work-bullet mt-1"></span>
                                                    <span class="ml-2 flex-1">${bullet}</span>
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                `).join('')}
                            </div>
                        </section>
                    ` : ''}

                    <!-- Education -->
                    ${data.education?.length > 0 ? `
                        <section class="mb-4">
                            <h2>EDUCATION</h2>
                            <div class="space-y-4">
                                ${data.education.map(edu => `
                                    <div>
                                        <div class="flex justify-between items-start">
                                            <h3>${edu.degree}</h3>
                                            <span class="text-xs text-gray-500 font-semibold">${edu.dates}</span>
                                        </div>
                                        <p class="text-indigo-600 text-sm font-medium">${edu.institution}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </section>
                    ` : ''}
                </div>
            `;

            // Combine both columns
            contentEl.innerHTML = darkColumnHtml + mainColumnHtml;
        }

        // --- ARRAY MANIPULATION FUNCTIONS ---

        function addItem(type) {
            if (!cvData[type]) cvData[type] = [];
            
            let newItem;
            if (type === 'languages') {
                newItem = { name: 'New Language', proficiency: 'Beginner' };
            } else if (type === 'education') {
                newItem = { degree: 'New Degree', institution: 'New University', dates: 'YYYY - YYYY' };
            } else if (type === 'workExperience') {
                newItem = { title: 'New Job Title', company: 'New Company', dates: 'YYYY - YYYY', bullets: ['Describe your achievement or responsibility here.'] };
            } else {
                newItem = type === 'skills' ? 'New Skill' : 'New Hobby';
            }

            cvData[type].push(newItem);
            debounceSave(cvData);
        }

        function removeItem(type, index) {
            if (cvData[type] && index >= 0 && index < cvData[type].length) {
                cvData[type].splice(index, 1);
                debounceSave(cvData);
            }
        }
        
        // --- MOBILE VIEW TOGGLE ---
        window.toggleView = function(action) {
            const container = document.body;
            const button = document.getElementById('toggleViewButton');
            
            if (action === 'toggle') {
                currentView = (currentView === 'editor') ? 'preview' : 'editor';
            } else if (action === 'editor') {
                currentView = 'editor';
            } else if (action === 'preview') {
                currentView = 'preview';
            }

            if (currentView === 'preview') {
                container.classList.add('show-preview-on-mobile');
                button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> Edit CV Data';
            } else {
                container.classList.remove('show-preview-on-mobile');
                button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg> View CV Preview';
            }
        }


        // Expose functions to the global scope for inline HTML event handlers
        window.handleInput = handleInput;
        window.handleArrayItemChange = handleArrayItemChange;
        window.handleBulletChange = handleBulletChange;
        window.addItem = addItem;
        window.removeItem = removeItem;
        window.addBullet = addBullet;
        window.removeBullet = removeBullet;

        // --- INITIALIZATION ---

        function init() {
            // 1. Load data from localStorage or use default
            const savedData = localStorage.getItem(STORAGE_KEY);
            cvData = savedData ? JSON.parse(savedData) : defaultCV;

            // 2. Render both the form and the CV preview
            renderForm(cvData);
            renderCV(cvData);

            // 3. Attach a single, centralized listener for all form inputs (non-array fields)
            document.getElementById('cv-editor-form').addEventListener('input', handleInput);
        }

        // Run initialization when the window loads
        window.onload = init;

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Builder (Local Storage & Backup)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Print Styles */
        @media print {
            @page { margin: 0; size: auto; }
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; background-color: white; }
            .no-print { display: none !important; }
            #preview-container { 
                display: block !important; 
                width: 100%; 
                max-width: none; 
                box-shadow: none;
                margin: 0;
            }
            #editor-container { display: none !important; }
            /* Ensure background colors print */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }

        /* Custom scrollbar for better UX */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans flex flex-col">

    <script>
        // --- API CONFIGURATION ---
        const API_KEY = ""; // Provided by the environment
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

        // --- LOCAL STORAGE CONSTANTS ---
        const STORAGE_KEY_LIST = 'resumeBuilder_list';
        const getResumeKey = (id) => `resumeBuilder_data_${id}`;
        const BACKUP_FILE_NAME = 'resume_builder_backup.json';

        // Expose functions globally for HTML event handlers
        window.switchTab = switchTab;
        window.printResume = printResume;
        window.updateData = updateData;
        window.updateArrayItem = updateArrayItem;
        window.addItem = addItem;
        window.removeItem = removeItem;
        window.updateExpPoint = updateExpPoint;
        window.addExpPoint = addExpPoint;
        window.removeExpPoint = removeExpPoint;
        window.saveResume = saveResume;
        window.loadResume = loadResume;
        window.deleteResume = deleteResume;
        window.newResume = newResume;
        window.inputField = inputField; 
        window.init = init; 
        window.exportData = exportData;
        window.handleImport = handleImport;
        window.autoGeneratePoints = autoGeneratePoints;
        window.updateAutoKeyButtonState = updateAutoKeyButtonState; // <--- NEW FUNCTION EXPOSED

        // --- INITIAL DATA ---
        const defaultData = {
            personal: {
                firstName: "Richard",
                lastName: "Sanchez",
                title: "Marketing Manager",
                summary: "This is a brief professional summary. Click the Edit tab to customize this content. All data is saved directly in your browser's Local Storage.",
                photoUrl: "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?ixlib=rb-1.2.1&auto=format&fit=crop&w=634&q=80"
            },
            contact: {
                phone: "+123-456-7890",
                email: "hello@reallygreatsite.com",
                address: "123 Anywhere St., Any City",
                website: "www.reallygreatsite.com"
            },
            education: [
                { id: 1, year: "2029 - 2030", school: "WARDIERE UNIVERSITY", degree: "Master of Business Management", details: "" },
            ],
            skills: ["Project Management", "Teamwork", "Effective Communication"],
            languages: ["English (Fluent)"],
            experience: [
                {
                    id: 1,
                    company: "Borcelle Studio",
                    role: "Marketing Manager & Specialist",
                    period: "2030 - PRESENT",
                    points: ["Develop and execute comprehensive marketing strategies.", "Successfully launched two product lines, resulting in a 15% revenue increase."]
                },
            ],
            references: []
        };
        
        let data = JSON.parse(JSON.stringify(defaultData)); // Deep copy initial data
        let savedResumes = []; // Array to hold { id, name } metadata of saved resumes
        let currentResumeId = null; // Tracks the ID of the resume currently being edited

        // --- UTILITY FUNCTIONS ---

        /** Helper for exponential backoff during API calls. */
        async function fetchWithBackoff(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    } else if (response.status === 429 || response.status >= 500) {
                        // Too many requests or server error - retry with backoff
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        // Non-retryable error
                        const errorBody = await response.json();
                        throw new Error(`API Error: ${response.status} ${response.statusText}. Details: ${JSON.stringify(errorBody)}`);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                }
            }
        }

        /**
         * Checks the role value and updates the disabled state of the Auto Key button.
         * This prevents a full re-render when typing in the role field.
         * @param {number} index The index of the experience object.
         * @param {string} roleValue The current value of the role input.
         */
        function updateAutoKeyButtonState(index, roleValue) {
            const btn = document.getElementById(`auto-key-btn-${index}`);
            if (btn) {
                btn.disabled = roleValue.trim() === '';
            }
        }

        // --- CORE LOGIC: AUTO-GENERATION (Updated with 12-word limit) ---

        /**
         * Automatically generates key achievements for a specific experience entry using the Gemini API.
         * @param {number} expIndex The index of the experience object in data.experience.
         */
        async function autoGeneratePoints(expIndex) {
            const job = data.experience[expIndex];
            const role = job.role.trim();

            if (!role) {
                showMessageBox("Please enter a Role before auto-generating achievements.", 'error');
                return;
            }
            
            const loadingSpinner = document.getElementById(`loading-spinner-${expIndex}`);
            const autoKeyBtn = document.getElementById(`auto-key-btn-${expIndex}`);
            
            // Show loading state
            loadingSpinner.classList.remove('hidden');
            autoKeyBtn.disabled = true;

            try {
                // *** UPDATED SYSTEM PROMPT: Enforces the 12-word limit ***
                const systemPrompt = `You are an expert career coach and resume writer. Your task is to generate 3 professional, high-impact, bullet-point achievements for a resume based on the provided job title. 
                Each achievement must focus on quantifiable results, skills, and impact, and **must not exceed 12 words**.
                The output must be a single string with achievements separated by newlines. Do not use introductory phrases or numbering.`;

                const userQuery = `Generate 3 key achievements for a resume for the role: ${role}.`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                const response = await fetchWithBackoff(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (generatedText) {
                    // Split the text by newline, trim whitespace, filter out empty strings, and take max 3
                    const newPoints = generatedText
                        .split('\n')
                        .map(p => p.trim())
                        .filter(p => p.length > 5 && p.startsWith('-') === false) // Filter out very short lines and lines that start with '-' if the model mistakenly added it
                        .slice(0, 3); // Limit to maximum 3

                    if (newPoints.length > 0) {
                        // Replace current points with new points
                        job.points = newPoints;
                        showMessageBox(`Successfully generated ${newPoints.length} achievements for ${role}.`, 'success');
                    } else {
                        showMessageBox("Generation was successful, but no valid achievements were returned.", 'error');
                    }
                } else {
                    throw new Error("API response was empty or malformed.");
                }

            } catch (e) {
                console.error("Auto-generation failed:", e);
                showMessageBox("Failed to generate achievements. Please ensure the API is accessible.", 'error');
            } finally {
                // Hide loading state and re-enable button
                loadingSpinner.classList.add('hidden');
                autoKeyBtn.disabled = false;
                renderEditor(); // Re-render to display the new points and update the button state
            }
        }


        // --- LOCAL STORAGE CRUD OPERATIONS ---
        
        /** Retrieves the list of saved resume metadata from local storage. */
        function fetchResumes() {
            try {
                const listJson = localStorage.getItem(STORAGE_KEY_LIST);
                savedResumes = listJson ? JSON.parse(listJson) : [];
            } catch (e) {
                console.error("Error reading saved list from localStorage: ", e);
                savedResumes = [];
            }
            renderLoadOptions(); // Update the UI dropdown
        }

        /** Saves the current resume data, updating if currentResumeId exists or creating a new one. */
        function saveResume() {
            try {
                // Determine if we are saving a new resume or updating an existing one
                const newId = currentResumeId || crypto.randomUUID();
                const resumeName = `${data.personal.firstName} ${data.personal.lastName} CV`;

                // 1. Prepare and save the main data object
                const dataToSave = JSON.parse(JSON.stringify(data)); // Deep copy current state
                localStorage.setItem(getResumeKey(newId), JSON.stringify(dataToSave));

                // 2. Update the resume list (metadata)
                const existingIndex = savedResumes.findIndex(r => r.id === newId);
                const metadata = {
                    id: newId,
                    name: resumeName,
                    timestamp: new Date().toISOString() // Store timestamp for sorting/display
                };

                if (existingIndex !== -1) {
                    // Update existing metadata
                    savedResumes[existingIndex] = metadata;
                } else {
                    // Add new metadata
                    savedResumes.push(metadata);
                }

                // 3. Save the updated list back to localStorage
                localStorage.setItem(STORAGE_KEY_LIST, JSON.stringify(savedResumes));

                currentResumeId = newId; // Set ID for future updates
                showMessageBox(`CV Saved: ${resumeName}!`, 'success');
                fetchResumes(); // Re-fetch/re-render load options
                renderEditor(); // Update status text
            } catch (e) {
                console.error("Error saving document to localStorage: ", e);
                showMessageBox("Error saving CV. Local Storage might be full or inaccessible.", 'error');
            }
        }

        /** Loads a selected resume into the editor. */
        function loadResume(id) {
            try {
                const resumeJson = localStorage.getItem(getResumeKey(id));
                const selected = savedResumes.find(r => r.id === id);

                if (resumeJson && selected) {
                    data = JSON.parse(resumeJson);
                    currentResumeId = id;
                    showMessageBox(`CV Loaded: ${selected.name}`, 'info');
                    renderEditor();
                    switchTab('edit');
                } else {
                    showMessageBox("Could not find the selected CV.", 'error');
                }
            } catch (e) {
                console.error("Error loading resume from localStorage: ", e);
                showMessageBox("Error loading CV data.", 'error');
            }
        }

        /** Deletes a selected resume from localStorage. */
        function deleteResume(id) {
            if (!confirmAction("Are you sure you want to delete this CV? This action cannot be undone.")) {
                return;
            }
            try {
                // 1. Remove the main data object
                localStorage.removeItem(getResumeKey(id));

                // 2. Remove the metadata from the list
                savedResumes = savedResumes.filter(r => r.id !== id);
                localStorage.setItem(STORAGE_KEY_LIST, JSON.stringify(savedResumes));

                if (currentResumeId === id) {
                    // If the current CV is deleted, start a new blank one
                    newResume(false); 
                }
                
                showMessageBox("CV deleted successfully.", 'success');
                fetchResumes(); // Update the load list
                renderEditor(); // Update status text
            } catch (e) {
                console.error("Error deleting document from localStorage: ", e);
                showMessageBox("Error deleting CV.", 'error');
            }
        }

        /** Clears the current editor content and starts a new CV. */
        function newResume(showConfirmation = true) {
            if (showConfirmation && !confirmAction("Are you sure you want to start a new, unsaved CV?")) {
                return;
            }
            
            data = JSON.parse(JSON.stringify(defaultData));
            currentResumeId = null;
            if (showConfirmation) {
                showMessageBox("New CV started.", 'info');
            }
            renderEditor();
        }

        // --- BACKUP AND RESTORE FUNCTIONS ---

        /** Exports all saved resumes as a single JSON file. */
        function exportData() {
            try {
                const backupData = {
                    metadata: savedResumes,
                    data: {}
                };

                // Fetch the actual content for all saved resumes
                for (const resume of savedResumes) {
                    const resumeKey = getResumeKey(resume.id);
                    const resumeContent = localStorage.getItem(resumeKey);
                    if (resumeContent) {
                        backupData.data[resume.id] = JSON.parse(resumeContent);
                    }
                }
                
                const json = JSON.stringify(backupData, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Create a temporary link element to trigger the download
                const a = document.createElement('a');
                a.href = url;
                a.download = BACKUP_FILE_NAME;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showMessageBox(`Successfully exported ${savedResumes.length} CVs as ${BACKUP_FILE_NAME}.`, 'success');

            } catch (e) {
                console.error("Error during data export:", e);
                showMessageBox("Error exporting data. Check console for details.", 'error');
            }
        }

        /** Handles the file import process (the Restore functionality). */
        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirmAction("WARNING: Importing data will overwrite existing CVs if their IDs match. Are you sure you want to proceed?")) {
                // Clear the file input so the user can try again if they cancel
                event.target.value = ''; 
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    if (!imported || !Array.isArray(imported.metadata) || typeof imported.data !== 'object') {
                        showMessageBox("Invalid backup file structure. Please upload a file generated by the export feature.", 'error');
                        return;
                    }

                    let importedCount = 0;
                    
                    // 1. Process and save the main data objects
                    for (const id in imported.data) {
                        localStorage.setItem(getResumeKey(id), JSON.stringify(imported.data[id]));
                        importedCount++;
                    }

                    // 2. Overwrite the metadata list with the imported list
                    localStorage.setItem(STORAGE_KEY_LIST, JSON.stringify(imported.metadata));
                    
                    // Reset current state to the first imported resume or the default new one
                    if (imported.metadata.length > 0) {
                        loadResume(imported.metadata[0].id);
                    } else {
                        newResume(false);
                    }

                    showMessageBox(`Restore complete! ${importedCount} CVs were imported.`, 'success');
                    fetchResumes(); // Re-render load options
                    renderEditor();

                } catch (error) {
                    console.error("Error parsing or importing backup file:", error);
                    showMessageBox("Failed to restore data. The file might be corrupted or not valid JSON.", 'error');
                } finally {
                    // Clear the file input to allow re-uploading the same file
                    event.target.value = ''; 
                }
            };

            reader.readAsText(file);
        }

        // --- UI & State Helpers ---
        
        /** Custom confirmation dialog placeholder. */
        function confirmAction(message) {
             // Using window.confirm() for simplicity since this is user-facing data manipulation
             return window.confirm(message); 
        }

        /** Custom message box for feedback (instead of alert). */
        function showMessageBox(message, type) {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'bg-blue-100', 'text-blue-800');
            box.classList.add('animate-in', 'fade-in-up', 'duration-300');

            if (type === 'success') box.classList.add('bg-green-100', 'text-green-800');
            else if (type === 'error') box.classList.add('bg-red-100', 'text-red-800');
            else box.classList.add('bg-blue-100', 'text-blue-800');

            setTimeout(() => {
                box.classList.add('hidden');
                box.classList.remove('animate-in', 'fade-in-up');
            }, 4000);
        }

        /** Renders the list of saved resumes in the dropdown. */
        function renderLoadOptions() {
            const container = document.getElementById('load-options');
            if (!container) return;
            
            // Sort by latest saved
            const sortedResumes = [...savedResumes].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            container.innerHTML = sortedResumes.map(resume => `
                <div class="flex justify-between items-center p-2 hover:bg-slate-100 rounded">
                    <button onclick="loadResume('${resume.id}')" class="text-sm text-slate-700 hover:text-blue-600 truncate flex-1 text-left">
                        ${resume.name} 
                        ${resume.id === currentResumeId ? '<span class="text-xs text-blue-500 font-bold">(Editing)</span>' : ''}
                    </button>
                    <button onclick="deleteResume('${resume.id}')" class="ml-2 text-red-400 hover:text-red-600 transition-colors">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `).join('');

            // If no resumes, display a message
            if (savedResumes.length === 0) {
                container.innerHTML = '<p class="text-sm text-slate-500 p-2">No saved CVs. Click "Save" to create your first one!</p>';
            }

            lucide.createIcons();
        }


        // --- CORE RESUME BUILDER LOGIC (Adapted) ---

        function init() {
            // No need for auth logic, just fetch local data and render
            fetchResumes();
            renderEditor();
            lucide.createIcons();
            switchTab('edit');
        }

        function switchTab(tab) {
            const editor = document.getElementById('editor-container');
            const preview = document.getElementById('preview-container');
            const btnEdit = document.getElementById('btn-edit');
            const btnPreview = document.getElementById('btn-preview');

            if (tab === 'edit') {
                editor.classList.remove('hidden');
                preview.classList.add('hidden');
                
                btnEdit.classList.add('bg-blue-600', 'text-white');
                btnEdit.classList.remove('bg-slate-700', 'text-gray-300', 'hover:bg-slate-600');
                
                btnPreview.classList.remove('bg-blue-600', 'text-white');
                btnPreview.classList.add('bg-slate-700', 'text-gray-300', 'hover:bg-slate-600');
            } else {
                renderPreview(); // Re-render preview with latest data
                editor.classList.add('hidden');
                preview.classList.remove('hidden');

                btnPreview.classList.add('bg-blue-600', 'text-white');
                btnPreview.classList.remove('bg-slate-700', 'text-gray-300', 'hover:bg-slate-600');

                btnEdit.classList.remove('bg-blue-600', 'text-white');
                btnEdit.classList.add('bg-slate-700', 'text-gray-300', 'hover:bg-slate-600');
            }
            lucide.createIcons();
        }

        function printResume() {
            switchTab('preview');
            setTimeout(() => window.print(), 300); // Small delay to ensure render
        }

        // --- DATA HANDLERS ---
        
        function updateData(path, value) {
            let parts = path.split('.');
            let obj = data;
            for (let i = 0; i < parts.length - 1; i++) {
                obj = obj[parts[i]];
            }
            obj[parts[parts.length - 1]] = value;
        }

        function updateArrayItem(category, index, field, value) {
            if (field) {
                data[category][index][field] = value;
            } else {
                data[category][index] = value; 
            }
            // FIX: Removed the renderEditor() call here to prevent loss of focus when typing in 'Role'.
        }

        function addItem(category, template) {
            if (template) {
                data[category].push({ ...template, id: Date.now() });
            } else {
                data[category].push("");
            }
            renderEditor();
            lucide.createIcons();
        }

        function removeItem(category, index) {
            data[category].splice(index, 1);
            renderEditor();
            lucide.createIcons();
        }

        // Nested experience points
        function updateExpPoint(expIndex, ptIndex, value) {
            data.experience[expIndex].points[ptIndex] = value;
        }

        function addExpPoint(expIndex) {
            data.experience[expIndex].points.push("");
            renderEditor();
            lucide.createIcons();
        }

        function removeExpPoint(expIndex, ptIndex) {
            data.experience[expIndex].points.splice(ptIndex, 1);
            renderEditor();
            lucide.createIcons();
        }


        // --- RENDERING FUNCTIONS ---

        function renderEditor() {
            const container = document.getElementById('editor-container');
            if (!container) return; 
            
            const currentName = currentResumeId ? savedResumes.find(r => r.id === currentResumeId)?.name || 'Untitled CV' : 'New/Unsaved CV';
            const saveButtonText = currentResumeId ? 'Update Current CV' : 'Save New CV';
            const saveButtonClass = currentResumeId ? 'bg-orange-500 hover:bg-orange-600' : 'bg-green-600 hover:bg-green-700';

            let html = `
                <!-- Save/Load Panel -->
                <div class="bg-blue-50 p-6 rounded-xl shadow-inner mb-8 border border-blue-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-blue-800 flex items-center gap-2">
                            <i data-lucide="archive" class="w-5 h-5"></i> CV Management (Local Storage)
                        </h2>
                        <span id="current-cv-status" class="text-sm font-medium px-3 py-1 rounded-full ${currentResumeId ? 'bg-orange-100 text-orange-700' : 'bg-slate-200 text-slate-700'}">
                            ${currentName}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <!-- Save/Update -->
                        <button onclick="saveResume()" class="py-3 px-4 rounded-lg font-bold text-white transition-colors flex items-center justify-center gap-2 ${saveButtonClass}">
                            <i data-lucide="save" class="w-5 h-5"></i> ${saveButtonText}
                        </button>
                        <!-- New -->
                        <button onclick="newResume(true)" class="py-3 px-4 rounded-lg font-bold text-slate-700 bg-slate-200 hover:bg-slate-300 transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="file-plus" class="w-5 h-5"></i> New CV
                        </button>
                        
                        <!-- Load Dropdown -->
                        <div class="relative group col-span-2">
                            <button class="w-full py-3 px-4 rounded-lg font-bold text-white bg-purple-600 hover:bg-purple-700 transition-colors flex items-center justify-center gap-2">
                                <i data-lucide="folder-open" class="w-5 h-5"></i> Load Saved CVs
                            </button>
                            <div class="absolute right-0 mt-2 w-full md:w-96 bg-white border border-gray-200 rounded-lg shadow-xl z-10 hidden group-hover:block max-h-60 overflow-y-auto">
                                <div id="load-options" class="p-2">
                                    <!-- Saved resumes list injected here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Export & Import/Restore Section -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-blue-100 pt-4">
                        <button onclick="exportData()" class="py-3 px-4 rounded-lg font-bold text-white bg-teal-600 hover:bg-teal-700 transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="download" class="w-5 h-5"></i> Export Backup (JSON)
                        </button>
                        <div class="relative">
                            <label for="import-file" class="w-full py-3 px-4 rounded-lg font-bold text-white bg-red-500 hover:bg-red-600 transition-colors flex items-center justify-center gap-2 cursor-pointer">
                                <i data-lucide="upload" class="w-5 h-5"></i> Import/Restore CVs
                            </label>
                            <!-- Hidden File Input -->
                            <input type="file" id="import-file" accept="application/json" onchange="handleImport(event)" class="hidden">
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-4 text-center italic">Your data is stored locally. Use Export/Import to create external backups.</p>
                </div>
                
                <!-- Personal Info -->
                <section class="space-y-4">
                    <h2 class="text-2xl font-bold text-slate-800 border-b pb-2">Personal Information</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${inputField('First Name', data.personal.firstName, "updateData('personal.firstName', this.value)")}
                        ${inputField('Last Name', data.personal.lastName, "updateData('personal.lastName', this.value)")}
                        ${inputField('Job Title', data.personal.title, "updateData('personal.title', this.value)", "md:col-span-2")}
                        ${inputField('Photo URL', data.personal.photoUrl, "updateData('personal.photoUrl', this.value)", "md:col-span-2")}
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Profile Summary</label>
                            <textarea oninput="updateData('personal.summary', this.value)" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all h-24">${data.personal.summary}</textarea>
                        </div>
                    </div>
                </section>

                <!-- Contact Info -->
                <section class="space-y-4">
                    <h2 class="text-2xl font-bold text-slate-800 border-b pb-2">Contact Details</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${inputField('Phone', data.contact.phone, "updateData('contact.phone', this.value)")}
                        ${inputField('Email', data.contact.email, "updateData('contact.email', this.value)")}
                        ${inputField('Address', data.contact.address, "updateData('contact.address', this.value)")}
                        ${inputField('Website', data.contact.website, "updateData('contact.website', this.value)")}
                    </div>
                </section>

                <!-- Experience -->
                <section class="space-y-4">
                    <div class="flex justify-between items-center border-b pb-2">
                        <h2 class="text-2xl font-bold text-slate-800">Work Experience</h2>
                        <button onclick="addItem('experience', {company: 'New Company', role: 'Role', period: '2024', points: ['']})" class="text-blue-600 hover:text-blue-800 flex items-center gap-1 text-sm font-medium"><i data-lucide="plus" class="w-4 h-4"></i> Add Job</button>
                    </div>
                    ${data.experience.map((job, idx) => `
                        <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 relative group">
                            <button onclick="removeItem('experience', ${idx})" class="absolute top-4 right-4 text-red-400 hover:text-red-600"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 pr-8">
                                ${inputField('Company', job.company, `updateArrayItem('experience', ${idx}, 'company', this.value)`)}
                                ${inputField('Period', job.period, `updateArrayItem('experience', ${idx}, 'period', this.value)`)}
                                <!-- FIX: Added updateAutoKeyButtonState to prevent re-render and loss of focus -->
                                ${inputField('Role', job.role, `updateArrayItem('experience', ${idx}, 'role', this.value); updateAutoKeyButtonState(${idx}, this.value);`, 'md:col-span-2')}
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-xs font-bold text-slate-500 uppercase">Key Achievements</label>
                                    <button id="auto-key-btn-${idx}" onclick="autoGeneratePoints(${idx})" class="text-xs text-purple-600 hover:text-purple-800 flex items-center gap-1 font-medium transition-colors disabled:opacity-50" ${job.role.trim() === '' ? 'disabled' : ''}>
                                        <i data-lucide="sparkles" class="w-3 h-3"></i> Auto Key
                                    </button>
                                </div>
                                <!-- Loading Spinner -->
                                <div id="loading-spinner-${idx}" class="text-xs text-purple-500 hidden items-center gap-2 px-2 py-1 bg-purple-50 rounded-md">
                                    <svg class="animate-spin -ml-1 h-4 w-4 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    Generating...
                                </div>
                                ${job.points.map((pt, pIdx) => `
                                    <div class="flex gap-2">
                                        <input value="${pt}" oninput="updateExpPoint(${idx}, ${pIdx}, this.value)" class="flex-1 p-2 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 outline-none" placeholder="Achievement...">
                                        <button onclick="removeExpPoint(${idx}, ${pIdx})" class="text-slate-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                `).join('')}
                                <button onclick="addExpPoint(${idx})" class="text-xs text-blue-600 font-medium hover:underline flex items-center gap-1 mt-1"><i data-lucide="plus" class="w-3 h-3"></i> Add Bullet Point</button>
                            </div>
                        </div>
                    `).join('')}
                </section>

                <!-- Education -->
                <section class="space-y-4">
                     <div class="flex justify-between items-center border-b pb-2">
                        <h2 class="text-2xl font-bold text-slate-800">Education</h2>
                        <button onclick="addItem('education', { year: '2024', school: 'University', degree: 'Degree', details: '' })" class="text-blue-600 hover:text-blue-800 flex items-center gap-1 text-sm font-medium"><i data-lucide="plus" class="w-4 h-4"></i> Add School</button>
                    </div>
                    ${data.education.map((edu, idx) => `
                        <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 relative">
                            <button onclick="removeItem('education', ${idx})" class="absolute top-4 right-4 text-red-400 hover:text-red-600"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pr-8">
                                ${inputField('School', edu.school, `updateArrayItem('education', ${idx}, 'school', this.value)`)}
                                ${inputField('Year', edu.year, `updateArrayItem('education', ${idx}, 'year', this.value)`)}
                                ${inputField('Degree', edu.degree, `updateArrayItem('education', ${idx}, 'degree', this.value)`)}
                                ${inputField('Details', edu.details, `updateArrayItem('education', ${idx}, 'details', this.value)`)}
                            </div>
                        </div>
                    `).join('')}
                </section>

                <!-- Skills & Languages -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <section class="space-y-4">
                         <div class="flex justify-between items-center border-b pb-2">
                            <h2 class="text-xl font-bold text-slate-800">Skills</h2>
                            <button onclick="addItem('skills')" class="text-blue-600 hover:text-blue-800"><i data-lucide="plus" class="w-5 h-5"></i></button>
                        </div>
                        <div class="space-y-2">
                            ${data.skills.map((skill, idx) => `
                                <div class="flex gap-2">
                                    <input value="${skill}" oninput="updateArrayItem('skills', ${idx}, null, this.value)" class="flex-1 p-2 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 outline-none">
                                    <button onclick="removeItem('skills', ${idx})" class="text-slate-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    </section>

                    <section class="space-y-4">
                         <div class="flex justify-between items-center border-b pb-2">
                            <h2 class="text-xl font-bold text-slate-800">Languages</h2>
                            <button onclick="addItem('languages')" class="text-blue-600 hover:text-blue-800"><i data-lucide="plus" class="w-5 h-5"></i></button>
                        </div>
                        <div class="space-y-2">
                            ${data.languages.map((lang, idx) => `
                                <div class="flex gap-2">
                                    <input value="${lang}" oninput="updateArrayItem('languages', ${idx}, null, this.value)" class="flex-1 p-2 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 outline-none">
                                    <button onclick="removeItem('languages', ${idx})" class="text-slate-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    </section>
                </div>
                
                 <!-- References -->
                <section class="space-y-4">
                    <div class="flex justify-between items-center border-b pb-2">
                        <h2 class="text-2xl font-bold text-slate-800">References</h2>
                        <button onclick="addItem('references', { name: 'Name', title: 'Title', phone: 'Phone', email: 'Email' })" class="text-blue-600 hover:text-blue-800 flex items-center gap-1 text-sm font-medium"><i data-lucide="plus" class="w-4 h-4"></i> Add Ref</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${data.references.map((ref, idx) => `
                            <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 relative">
                                <button onclick="removeItem('references', ${idx})" class="absolute top-2 right-2 text-red-400 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                <div class="space-y-2 pr-6">
                                    ${inputField('Name', ref.name, `updateArrayItem('references', ${idx}, 'name', this.value)`)}
                                    ${inputField('Title', ref.title, `updateArrayItem('references', ${idx}, 'title', this.value)`)}
                                    ${inputField('Phone', ref.phone, `updateArrayItem('references', ${idx}, 'phone', this.value)`)}
                                    ${inputField('Email', ref.email, `updateArrayItem('references', ${idx}, 'email', this.value)`)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </section>
            `;
            container.innerHTML = html;
            renderLoadOptions(); 
            lucide.createIcons();
        }

        function renderPreview() {
            const container = document.getElementById('preview-container');
            
            // Generate List Items
            const skillsHtml = data.skills.map(s => `<li>${s}</li>`).join('');
            const langsHtml = data.languages.map(l => `<li>${l}</li>`).join('');
            
            // Generate Education
            const eduHtml = data.education.map(edu => `
                <div>
                    <div class="text-lg font-semibold mb-1">${edu.year}</div>
                    <div class="font-medium text-white/90 uppercase">${edu.school}</div>
                    <div class="text-sm font-light text-white/70 mt-1">${edu.degree}</div>
                    ${edu.details ? `<div class="text-sm font-light text-white/70">${edu.details}</div>` : ''}
                </div>
            `).join('');

            // Generate Experience
            const expHtml = data.experience.map(job => `
                <div class="relative pl-8 md:pl-12 break-inside-avoid">
                    <div class="absolute -left-[9px] top-1.5 w-4 h-4 rounded-full bg-slate-600 border-4 border-white shadow-sm"></div>
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-baseline mb-1">
                        <h4 class="text-lg font-bold text-slate-800">${job.company}</h4>
                        <span class="text-sm font-medium text-slate-500 mt-1 sm:mt-0 uppercase">${job.period}</span>
                    </div>
                    <div class="text-slate-500 font-medium mb-3 italic">${job.role}</div>
                    <ul class="list-disc pl-4 text-slate-600 space-y-2 text-sm leading-relaxed marker:text-slate-400">
                        ${job.points.map(pt => `<li>${pt}</li>`).join('')}
                    </ul>
                </div>
            `).join('');

            // Generate References
            const refHtml = data.references.map(ref => `
                <div>
                    <div class="font-bold text-lg text-slate-800">${ref.name}</div>
                    <div class="text-slate-500 font-medium">${ref.title}</div>
                    <div class="mt-2 text-sm text-slate-600">
                        <p><span class="font-semibold w-12 inline-block">Phone:</span> ${ref.phone}</p>
                        <p><span class="font-semibold w-12 inline-block">Email:</span> ${ref.email}</p>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `
                <!-- LEFT COLUMN (SIDEBAR) -->
                <div class="w-full md:w-1/3 bg-[#1e2a3a] text-white p-8 md:p-10 flex flex-col gap-10 print:w-1/3 print:h-screen">
                    <!-- Profile Picture -->
                    <div class="flex justify-center mb-2">
                        <div class="w-48 h-48 rounded-full border-[6px] border-white/20 overflow-hidden relative shadow-lg">
                            <img src="${data.personal.photoUrl}" onerror="this.src='https://via.placeholder.com/150'" alt="Profile" class="w-full h-full object-cover"/>
                        </div>
                    </div>

                    <!-- CONTACT -->
                    <section>
                        <h3 class="text-xl font-bold uppercase tracking-[0.15em] border-b border-white/30 pb-3 mb-6">Contact</h3>
                        <div class="flex flex-col gap-4 text-sm font-light tracking-wide">
                            <div class="flex items-center gap-3">
                                <div class="bg-white/10 p-2 rounded-full"><i data-lucide="phone" class="w-4 h-4"></i></div>
                                <span>${data.contact.phone}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="bg-white/10 p-2 rounded-full"><i data-lucide="mail" class="w-4 h-4"></i></div>
                                <span class="break-all">${data.contact.email}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="bg-white/10 p-2 rounded-full"><i data-lucide="map-pin" class="w-4 h-4"></i></div>
                                <span>${data.contact.address}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="bg-white/10 p-2 rounded-full"><i data-lucide="globe" class="w-4 h-4"></i></div>
                                <span>${data.contact.website}</span>
                            </div>
                        </div>
                    </section>

                    <!-- EDUCATION -->
                    <section>
                        <h3 class="text-xl font-bold uppercase tracking-[0.15em] border-b border-white/30 pb-3 mb-6">Education</h3>
                        <div class="flex flex-col gap-6">${eduHtml}</div>
                    </section>

                    <!-- SKILLS -->
                    <section>
                        <h3 class="text-xl font-bold uppercase tracking-[0.15em] border-b border-white/30 pb-3 mb-6">Skills</h3>
                        <ul class="flex flex-col gap-3 text-sm font-light list-disc pl-4 marker:text-white/50">${skillsHtml}</ul>
                    </section>

                    <!-- LANGUAGES -->
                    <section>
                        <h3 class="text-xl font-bold uppercase tracking-[0.15em] border-b border-white/30 pb-3 mb-6">Languages</h3>
                        <ul class="flex flex-col gap-3 text-sm font-light list-disc pl-4 marker:text-white/50">${langsHtml}</ul>
                    </section>
                </div>

                <!-- RIGHT COLUMN (MAIN CONTENT) -->
                <div class="w-full md:w-2/3 bg-white p-8 md:p-12 text-slate-800 print:w-2/3">
                    <!-- HEADER -->
                    <header class="mb-12 mt-4">
                        <h1 class="text-5xl md:text-6xl font-bold text-slate-700 uppercase tracking-tight mb-2">
                            ${data.personal.firstName} <span class="font-light text-slate-600">${data.personal.lastName}</span>
                        </h1>
                        <h2 class="text-xl tracking-[0.2em] text-slate-500 uppercase font-medium">${data.personal.title}</h2>
                        <div class="w-24 h-1 bg-slate-700 mt-6"></div>
                    </header>

                    <!-- PROFILE -->
                    <section class="mb-10">
                        <h3 class="text-xl font-bold uppercase tracking-[0.15em] text-slate-700 mb-5 border-b-2 border-slate-200 pb-2 inline-block w-full">Profile</h3>
                        <p class="text-slate-600 leading-relaxed text-justify whitespace-pre-wrap">${data.personal.summary}</p>
                    </section>

                    <!-- WORK EXPERIENCE -->
                    <section class="mb-10">
                        <h3 class="text-xl font-bold uppercase tracking-[0.15em] text-slate-700 mb-8 border-b-2 border-slate-200 pb-2 inline-block w-full">Work Experience</h3>
                        <div class="relative border-l-2 border-slate-300 ml-3 md:ml-4 space-y-10 pb-2">
                            ${expHtml}
                        </div>
                    </section>

                    <!-- REFERENCES -->
                    <section class="break-inside-avoid">
                        <h3 class="text-xl font-bold uppercase tracking-[0.15em] text-slate-700 mb-6 border-b-2 border-slate-200 pb-2 inline-block w-full">Reference</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">${refHtml}</div>
                    </section>
                </div>
            `;
            lucide.createIcons();
        }

        // Helper for input fields
        function inputField(label, value, onInput, className = "") {
            return `
                <div class="${className}">
                    <label class="block text-sm font-medium text-slate-700 mb-1">${label}</label>
                    <input type="text" value="${value}" oninput="${onInput}" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
                </div>
            `;
        }

        // --- Execute Initialization ---
        window.onload = init;
    </script>

    <!-- NAVIGATION BAR -->
    <nav class="bg-slate-800 text-white p-4 sticky top-0 z-50 shadow-md no-print flex justify-between items-center">
        <h1 class="font-bold text-lg hidden md:block">Resume Builder (Local Storage & Backup)</h1>
        <div class="flex gap-2">
            <button onclick="switchTab('edit')" id="btn-edit" class="px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium transition-colors bg-blue-600 text-white">
                <i data-lucide="edit-3" class="w-4 h-4"></i> Edit
            </button>
            <button onclick="switchTab('preview')" id="btn-preview" class="px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium transition-colors bg-slate-700 text-gray-300 hover:bg-slate-600">
                <i data-lucide="eye" class="w-4 h-4"></i> Preview
            </button>
            <div class="w-px bg-slate-600 mx-2"></div>
            <button onclick="printResume()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg shadow-sm transition-colors flex items-center gap-2 font-medium text-sm">
                <i data-lucide="printer" class="w-4 h-4"></i> Print PDF
            </button>
        </div>
    </nav>

    <!-- MAIN CONTENT AREA -->
    <main class="flex-1 flex justify-center p-4 md:p-8">
        
        <!-- EDITOR SECTION -->
        <div id="editor-container" class="w-full max-w-3xl bg-white rounded-xl shadow-lg p-6 md:p-8 space-y-8 animate-in fade-in duration-200">
            <!-- Content injected by JS -->
        </div>

        <!-- PREVIEW SECTION (Hidden by default) -->
        <div id="preview-container" class="hidden w-full max-w-[1000px] bg-white shadow-2xl flex flex-col md:flex-row animate-in fade-in zoom-in-95 duration-200">
            <!-- Content injected by JS -->
        </div>

    </main>

    <!-- MESSAGE BOX (for status updates) -->
    <div id="message-box" class="fixed bottom-4 right-4 p-4 rounded-lg shadow-lg hidden text-sm font-medium transition-all duration-300 z-[100]">
        Status Message
    </div>
</body>
</html>
